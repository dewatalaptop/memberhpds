<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Member - Dolan Sawah</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0');

        :root{
            --primary-color:#00796B; --primary-light:#00897B; --accent-color:#F57C00; --accent-hover:#EF6C00;
            --bg-light:#F4F6F8; --bg-white:#FFFFFF; --text-dark:#333; --text-light:#FFF;
            --border-color:#E0E0E0; --shadow:0 4px 6px rgba(0,0,0,.1); --font-body:'Poppins',sans-serif;
            --danger-color:#d9534f; --danger-hover:#c9302c; --info-color:#5bc0de; --info-hover:#31b0d5;
            --warning-color:#f0ad4e; --warning-hover:#ec971f;
            --wa-color: #25D366; --wa-dark: #128C7E; /* Warna Resmi WhatsApp */
        }

        *{box-sizing:border-box}
        body{font-family:var(--font-body); background:var(--bg-light); color:var(--text-dark); margin:0; padding:20px}
        .container{width:100%; max-width:700px; margin:0 auto; background:var(--bg-white); border-radius:12px; box-shadow:var(--shadow); overflow:hidden}

        header{background:linear-gradient(135deg,var(--primary-light),var(--primary-color)); color:var(--text-light); padding:20px; text-align:center}
        header h1{margin:0; font-size:1.8em; font-weight:700}

        .nav{display:flex; background:#FDFDFD; border-bottom:1px solid var(--border-color)}
        .nav-button{flex:1; padding:15px; background:transparent; border:none; border-bottom:4px solid transparent; color:var(--text-dark); cursor:pointer; font-size:.95em; font-weight:600; transition:all .3s; opacity:.6}
        .nav-button:hover{opacity:1}
        .nav-button.active{opacity:1; color:var(--primary-color); border-bottom:4px solid var(--primary-color)}

        main{padding:25px}
        h2,h3{color:var(--primary-color); text-align:center}
        h3{margin-bottom: 20px;}
        h4{margin-top:25px; border-top:1px solid var(--border-color); padding-top:20px}
        .section h4:first-child { margin-top:0; border-top:none; padding-top:0; }

        .section{display:none}
        .section.active{display:block}

        .form-group{margin-bottom:16px}
        .form-group label{display:block; margin-bottom:8px; font-weight:500}
        .form-group input,.form-group select{width:100%; padding:12px; border:1px solid var(--border-color); border-radius:8px; font-size:1em}
        .form-group input:focus{border-color:var(--primary-color); outline:none}
        .form-group small {font-size: 0.8em; color: #777; margin-top: 4px; display: block;}


        .btn{width:100%; padding:15px; border:none; border-radius:8px; cursor:pointer; font-size:1.05em; font-weight:600; transition:all .3s; display:flex; justify-content:center; align-items:center; gap:8px}
        .btn .material-symbols-outlined{font-size:1.2em}
        .btn-primary{background:var(--accent-color); color:var(--text-light)}
        .btn-primary:hover{background:var(--accent-hover)}
        .btn-secondary{background:var(--bg-white); color:var(--accent-color); border:2px solid var(--accent-color); padding:13px}
        .btn-secondary:hover{background:var(--accent-color); color:var(--text-light)}
        .btn-danger{background:var(--danger-color); color:var(--text-light)}
        .btn-danger:hover{background:var(--danger-hover)}
        .btn-info{background:var(--info-color); color:var(--text-light)}
        .btn-info:hover{background:var(--info-hover)}
        .btn-warning{background:var(--warning-color); color:var(--text-light)}
        .btn-warning:hover{background:var(--warning-hover)}
        
        .btn:disabled{opacity:.7; cursor:not-allowed}

        .spinner{width:20px; height:20px; border:3px solid rgba(255,255,255,.3); border-top-color:var(--text-light); border-radius:50%; display:none; animation:spin 1s linear infinite}
        .btn-secondary .spinner{border-color:rgba(0,0,0,.2); border-top-color:var(--accent-color)}
        .btn.loading .btn-text{display:none}
        .btn.loading .spinner{display:block}
        @keyframes spin{to{transform:rotate(360deg)}}

        #status-message, #admin-login-status, #transaction-status {padding:14px; margin-top:16px; border-radius:8px; opacity:0; visibility:hidden; transform:translateY(6px); transition:all .25s ease}
        #status-message.visible, #admin-login-status.visible, #transaction-status.visible {opacity:1; visibility:visible; transform:translateY(0)}
        #status-message.success, #admin-login-status.success, #transaction-status.success {background:#DFF0D8; color:#3C763D; border:1px solid #D6E9C6}
        #status-message.error, #admin-login-status.error, #transaction-status.error {background:#F2DEDE; color:#A94442; border:1px solid #EBCCD1}

        .birthday-notification{padding:15px; background:#FFEB3B; color:#333; border:1px solid #FFC107; border-radius:8px; margin-bottom:20px; text-align:center; font-weight:600; display:none}
        .birthday-notification.show{display:block}

        .overlay{position:fixed; inset:0; background:rgba(0,0,0,.8); backdrop-filter:blur(8px); z-index:1000; display:flex; justify-content:center; align-items:center; padding:20px; opacity:0; visibility:hidden; transition:opacity .4s ease, visibility .4s ease}
        .overlay.visible{opacity:1; visibility:visible}
        .overlay-content{background:var(--bg-white); padding:20px; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.3); width:calc(100% - 40px); max-width:700px; max-height:90vh; overflow:auto; transform:scale(.96); transition:transform .3s cubic-bezier(.2,.8,.2,1)}
        .overlay.visible .overlay-content{transform:scale(1)}

        #back-to-search-btn{background:transparent; border:2px solid var(--primary-color); color:var(--primary-color); font-size:1em; padding:12px; margin-bottom:20px; width:auto}
        #back-to-search-btn:hover{background:var(--primary-color); color:var(--text-light)}

        .poin{font-weight:700; font-size:2.4em; color:var(--primary-color); display:block; text-align:center; margin-bottom:12px}

        #claimable-rewards h4{font-size:1.05em; color:var(--text-dark); text-align:left}
        .reward-item{display:flex; justify-content:space-between; align-items:center; padding:12px; border-radius:8px; margin-bottom:10px; background:#f7f7f7; border:1px solid var(--border-color); transition:all .2s}
        .reward-item:hover{background:#f0f0f0}
        .redeem-btn{padding:8px 16px; font-size:.9em; width:auto}

        .reward-list-container{list-style:none; padding:0}
        .reward-list-container li{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:12px; border-radius:8px; margin-bottom:8px; background:#F9F9F9; border:1px solid var(--border-color)}
        .delete-reward-btn{padding:8px 12px; font-size:.85em; width:auto}

        #member-detail-overlay h3{font-size:1.4em; margin-bottom:14px}
        #member-detail-overlay p{font-size:1.05em; margin-bottom:10px}
        #member-detail-overlay strong{font-weight:600}
        
        .btn-options{display:flex; flex-direction:column; gap:12px; margin-top:16px}
        .reward-subsection{margin-top:20px}
        .divider{border-top:1px dashed var(--border-color); margin:24px 0}

        .stats-filter{display:flex; justify-content:center; gap:10px; margin:8px 0 18px}
        .stats-filter button{background:var(--bg-white); color:var(--primary-color); border:2px solid var(--border-color); padding:8px 14px; border-radius:18px; font-weight:600; cursor:pointer; transition:all .25s}
        .stats-filter button.active,.stats-filter button:hover{background:var(--primary-color); color:var(--text-light); border-color:var(--primary-color)}

        .stats-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:12px}
        .stat-card{background:#FDFDFD; padding:16px; border-radius:12px; border:1px solid var(--border-color); text-align:center}
        .stat-card h4{margin:0 0 8px 0; font-size:1em; font-weight:600; color:var(--text-dark); border-top:none; padding-top:0}
        .stat-value{font-size:2.1em; font-weight:700; color:var(--accent-color); display:block}

        .chart-container{margin-top:20px; padding:16px; border-radius:12px; background:#FDFDFD; border:1px solid var(--border-color)}
        .chart-container h3{margin:0 0 12px 0}
        #info-source-chart{width:100% !important; height:320px !important; display:block}
        @media (max-width:480px){ #info-source-chart{height:260px !important} }

        .data-list{list-style:none; padding:0; margin-top:12px}
        .data-list-item{padding:10px 6px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center; font-size:.98em}
        .data-list-item:last-child{border-bottom:none}
        .data-list-item small { display: block; color: #555; font-size: 0.9em; margin-top: 2px; }

        #all-members-list {list-style:none; padding:0; margin-top:10px}
        .member-list-item{display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:10px; padding:12px; border-radius:8px; margin-bottom:8px; background:#F9F9F9; border:1px solid var(--border-color)}
        .member-list-item-info{flex-grow:1}
        .member-list-item-info strong{display:block; font-size:1.05em; color:var(--text-dark)}
        .member-list-item-info span{color:#666}
        .member-list-item-actions{display:flex; gap:8px; width:100%; justify-content:flex-end; flex-wrap: wrap;}
        @media (min-width:500px){ .member-list-item-actions{width:auto} }
        .member-list-item-actions .btn{width:auto; padding:8px 14px; font-size:.9em}

        /* --- STYLE BARU: CARD & WA SHARE --- */
        #rekap-member-list { list-style: none; padding: 0; display: flex; flex-direction: column; gap: 12px; margin-top: 15px; }

        .rekap-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.06);
            border: 1px solid #eee;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .rekap-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        
        .rekap-card.verified { border-left: 6px solid var(--primary-color); }
        .rekap-card.unverified { border-left: 6px solid var(--danger-color); }

        .rekap-card-header {
            padding: 12px 15px;
            background: #fdfdfd;
            border-bottom: 1px dashed #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .rekap-name { font-size: 1.1em; font-weight: 700; color: #333; margin-bottom: 2px; display:block; }
        .rekap-phone { font-size: 0.95em; color: #666; display: flex; align-items: center; gap: 4px; }
        .rekap-status-badge {
            font-size: 0.75em; font-weight: 700; padding: 4px 8px; border-radius: 20px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .rekap-status-badge.v { background: #e0f2f1; color: var(--primary-color); }
        .rekap-status-badge.u { background: #ffebee; color: var(--danger-color); }

        .rekap-card-body { padding: 12px 15px; font-size: 0.9em; color: #555; }
        .rekap-row { display: flex; margin-bottom: 6px; align-items: flex-start; }
        .rekap-row:last-child { margin-bottom: 0; }
        .rekap-label { min-width: 90px; color: #888; font-weight: 500; font-size: 0.9em; }
        .rekap-val { font-weight: 600; color: #444; flex: 1; word-break: break-word; }

        /* Tombol Verifikasi di dalam Card */
        .rekap-card-action { padding: 10px 15px; background: #fafafa; border-top: 1px solid #eee; text-align: right; }
        
        /* Tombol GLOBAL Share Laporan (Paling Bawah) */
        #share-rekap-wa-btn {
            background-color: var(--wa-color);
            color: #fff;
            margin-top: 20px;
            border-radius: 50px; /* Bentuk kapsul */
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4);
            font-weight: 700;
        }
        #share-rekap-wa-btn:hover {
            background-color: var(--wa-dark);
            transform: translateY(-2px);
        }
        /* --- END STYLE BARU --- */

        .admin-header{display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;}
        #logout-btn {width: auto; padding: 10px 20px; background-color: var(--danger-color);}
        #logout-btn:hover {background-color: var(--danger-hover);}

        #global-loader {
            position: fixed; inset: 0; z-index: 9999; background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: opacity .3s, visibility .3s;
        }
        #global-loader.visible { opacity: 1; visibility: visible; }
        #global-loader .spinner {
            display: block; width: 50px; height: 50px; border-width: 5px;
            border-color: rgba(0,0,0,.2); border-top-color: var(--primary-color);
        }

        .admin-nav {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 25px;
        }
        .admin-nav-button {
            flex: 1;
            padding: 14px 10px;
            font-size: 0.9em;
            font-weight: 600;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-dark);
            opacity: 0.7;
            position: relative;
            transition: opacity 0.3s, color 0.3s;
        }
        .admin-nav-button:hover {
            opacity: 1;
            color: var(--primary-color);
        }
        .admin-nav-button::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background-color: var(--primary-color);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        .admin-nav-button.active {
            opacity: 1;
            color: var(--primary-color);
        }
        .admin-nav-button.active::after {
            transform: scaleX(1);
        }

        .admin-tab-pane {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        .admin-tab-pane.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .admin-tab-pane h3 {
            text-align: left;
            font-size: 1.5em;
            margin-bottom: 20px;
        }
         .admin-tab-pane h4 {
            font-size: 1.1em;
            color: var(--text-dark);
            text-align: left;
            margin-top: 30px;
            padding-top: 0;
            border-top: none;
        }
        .admin-tab-pane h5 {
            text-align: left;
            margin-top: 20px;
            font-weight: 600;
        }
    </style>
</head>
<body>

<div id="global-loader">
    <div class="spinner"></div>
</div>

<div class="container">
    <header><h1>Sistem Member Dolan Sawah</h1></header>

    <div class="nav">
        <button id="nav-search" class="nav-button active">Cari Member</button>
        <button id="nav-register" class="nav-button">Daftar Member</button>
        <button id="nav-admin" class="nav-button">Administrator</button>
    </div>

    <main>
        <section id="search-section" class="section active">
            <h2>Cari & Info Member</h2>
            <form id="search-form" autocomplete="off">
                <div class="form-group">
                    <label for="search-hp">Nomor HP Member</label>
                    <input type="tel" id="search-hp" placeholder="Contoh: 081234567890" required autofocus>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span class="btn-text">Cari Member</span>
                    <span class="material-symbols-outlined">search</span>
                    <span class="spinner"></span>
                </button>
            </form>
        </section>

        <section id="register-section" class="section">
            <h2>Pendaftaran Member Baru</h2>
            <form id="register-form">
                <div class="form-group"><label for="nama">Nama Lengkap</label><input type="text" id="nama" required></div>
                <div class="form-group"><label for="alamat">Alamat</label><input type="text" id="alamat" placeholder="Contoh: Jl. Pahlawan No. 1, Semarang" required></div>
                <div class="form-group"><label for="nomor-hp">Nomor HP Aktif</label><input type="tel" id="nomor-hp" placeholder="Contoh: 081234567890" required></div>
                <div class="form-group"><label for="tanggal-lahir">Tanggal Lahir</label><input type="date" id="tanggal-lahir" required></div>
                <div class="form-group">
                    <label for="sumber-info">Tahu Resto dari Mana?</label>
                    <select id="sumber-info" required>
                        <option value="">-- Pilih --</option>
                        <option>Instagram</option><option>Tiktok</option><option>Teman/Keluarga</option><option>Lainnya</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="instagram">Username Instagram (Opsional)</label>
                    <input type="text" id="instagram" placeholder="Contoh: dolansawah.resto">
                    <small>Cukup masukkan username, tanpa "@"</small>
                </div>
                <div class="form-group">
                    <label for="tiktok">Username TikTok (Opsional)</label>
                    <input type="text" id="tiktok" placeholder="Contoh: dolansawah.official">
                     <small>Cukup masukkan username, tanpa "@"</small>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span class="btn-text">Daftarkan Member</span>
                    <span class="material-symbols-outlined">person_add</span>
                    <span class="spinner"></span>
                </button>
            </form>
        </section>

        <section id="admin-section" class="section">
            <div id="admin-login-view">
                <h2>Login Administrator</h2>
                <form id="admin-login-form">
                    <div class="form-group"><label for="admin-email">Email</label><input type="email" id="admin-email" required></div>
                    <div class="form-group"><label for="admin-password">Password</label><input type="password" id="admin-password" required></div>
                    <button type="submit" class="btn btn-primary"><span class="btn-text">Login</span><span class="spinner"></span></button>
                </form>
                <div id="admin-login-status"></div>
            </div>

            <div id="admin-content-view" style="display:none;">
                <div class="admin-header">
                    <h2>Panel Admin</h2>
                    <button id="logout-btn" class="btn btn-danger">
                        <span class="btn-text">Logout</span>
                        <span class="material-symbols-outlined">logout</span>
                    </button>
                </div>

                <div class="admin-nav">
                    <button class="admin-nav-button active" data-target="admin-tab-management">Manajemen</button>
                    <button class="admin-nav-button" data-target="admin-tab-rewards">Rewards</button>
                    <button class="admin-nav-button" data-target="admin-tab-stats">Statistik</button>
                </div>

                <div id="admin-tab-management" class="admin-tab-pane active">
                    <h3>Manajemen Member</h3>
                    <div class="btn-options">
                        <button id="show-all-members-btn" class="btn btn-secondary">
                            <span class="btn-text">Lihat Semua Data Member</span>
                            <span class="material-symbols-outlined">group</span>
                        </button>
                        <button id="rekap-member-baru-btn" class="btn btn-secondary">
                            <span class="btn-text">Rekap Member Baru</span>
                            <span class="material-symbols-outlined">history</span>
                        </button>
                    </div>
                </div>
                
                <div id="admin-tab-rewards" class="admin-tab-pane">
                    <h3>Pengaturan Reward</h3>
                    <div id="point-rewards-container">
                        <h4>Reward Poin</h4>
                        <form id="add-point-reward-form">
                            <div class="form-group"><label for="reward-name">Nama Reward</label><input type="text" id="reward-name" placeholder="Contoh: Gratis Es Teh" required></div>
                            <div class="form-group"><label for="reward-points">Poin Dibutuhkan</label><input type="number" id="reward-points" placeholder="Contoh: 5" required></div>
                            <button type="submit" class="btn btn-primary"><span class="btn-text">Tambah Reward Poin</span><span class="spinner"></span></button>
                        </form>
                        <h5>Daftar Reward Poin Aktif</h5>
                        <ul id="point-reward-list" class="reward-list-container"></ul>
                    </div>
                    <div id="birthday-rewards-container" class="reward-subsection">
                        <h4>Reward Spesial Ulang Tahun</h4>
                        <form id="add-birthday-reward-form">
                            <div class="form-group"><label for="birthday-reward-name">Nama Reward</label><input type="text" id="birthday-reward-name" placeholder="Contoh: Potongan Spesial 15%" required></div>
                            <button type="submit" class="btn btn-primary"><span class="btn-text">Tambah Reward Ultah</span><span class="spinner"></span></button>
                        </form>
                        <h5>Daftar Reward Ultah Aktif</h5>
                        <ul id="birthday-reward-list" class="reward-list-container"></ul>
                    </div>

                    <div id="top-member-reward-container" class="reward-subsection">
                        <h4>Reward Top 5 Member</h4>
                        <form id="save-top-member-reward-form">
                            <div class="form-group">
                                <label for="top-member-reward-name">Nama Reward</label>
                                <input type="text" id="top-member-reward-name" placeholder="Contoh: Member Sultan (Otomatis)" required>
                                <small>Reward ini akan tampil otomatis di profil 5 member dengan poin tertinggi. Cukup atur satu nama reward.</small>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <span class="btn-text">Simpan Reward Top 5</span>
                                <span class="spinner"></span>
                            </button>
                        </form>
                        <h5>Reward Top 5 Aktif Saat Ini</h5>
                        <p id="current-top-member-reward" style="font-weight: 600; color: var(--primary-color);">Belum diatur.</p>
                    </div>
                </div>

                <div id="admin-tab-stats" class="admin-tab-pane">
                    <h3>Statistik Member</h3>
                    <div class="stats-filter">
                        <button class="active" data-period="today">Hari Ini</button>
                        <button data-period="week">Minggu Ini</button>
                        <button data-period="month">Bulan Ini</button>
                        <button data-period="all">Semua</button>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card"><h4>Total Member</h4><span id="stat-total-members" class="stat-value">0</span></div>
                        <div class="stat-card"><h4>Member Baru</h4><span id="stat-new-members" class="stat-value">0</span></div>
                        <div class="stat-card"><h4>Member Datang</h4><span id="stat-visiting-members" class="stat-value">0</span></div>
                        <div class="stat-card"><h4>Reward Ditukar</h4><span id="stat-redeemed-rewards" class="stat-value">0</span></div>
                    </div>
                    <div class="chart-container">
                        <h4>Sumber Informasi Member</h4>
                        <canvas id="info-source-chart"></canvas>
                        <ul id="info-source-list" class="data-list"></ul>
                    </div>
                    <div id="address-stats-container" class="chart-container">
                        <h4>Pengunjung Berdasarkan Alamat (Kota/Kab)</h4>
                        <ul id="address-stats-list" class="data-list"></ul>
                    </div>
                </div>
            </div>
        </section>

        <div id="status-message"></div>
    </main>
</div>

<div id="member-detail-overlay" class="overlay">
    <div class="overlay-content">
        <button id="back-to-search-btn" class="btn">
            <span class="btn-text">Tutup</span>
            <span class="material-symbols-outlined">close</span>
        </button>

        <div id="birthday-notification" class="birthday-notification"></div>

        <h3>Detail Member</h3>
        <p><strong>Nama:</strong> <span id="info-nama"></span></p>
        <p><strong>Poin Terkumpul:</strong> <span id="info-poin" class="poin"></span></p>
        <p style="text-align:center; margin-top:-10px; margin-bottom: 20px;"><strong>Akumulasi Belanja:</strong> Rp <span id="info-sisa">0</span></p>
        <div id="claimable-rewards"></div>

        <div class="btn-options">
            <a id="whatsapp-member-btn" href="#" target="_blank" class="btn btn-info">
                <span class="btn-text">Hubungi via WhatsApp</span>
                <span class="material-symbols-outlined">sms</span>
            </a>
        </div>

        <div id="transaction-form">
            <h4>Tambah Transaksi & Poin</h4>
            <form id="add-transaction-form">
                <div class="form-group">
                    <label for="transaction-amount">Nominal Transaksi (Rp)</label>
                    <input type="number" id="transaction-amount" placeholder="Contoh: 150000" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span class="btn-text">Simpan & Hitung Poin</span>
                    <span class="material-symbols-outlined">save</span>
                    <span class="spinner"></span>
                </button>
            </form>
            <div id="transaction-status"></div>
        </div>
    </div>
</div>

<div id="all-members-overlay" class="overlay">
    <div class="overlay-content">
        <button id="close-all-members-btn" class="btn btn-secondary" style="width:auto; margin-bottom:20px;">
            <span class="material-symbols-outlined">close</span>
        </button>
        <h3>Semua Data Member</h3>
        <div class="form-group">
            <input type="tel" id="search-all-members-input" placeholder="Cari berdasarkan nomor HP...">
        </div>
        <ul id="all-members-list"></ul>
    </div>
</div>

<div id="rekap-member-overlay" class="overlay">
    <div class="overlay-content">
        <button id="close-rekap-btn" class="btn btn-secondary" style="width:auto; margin-bottom:20px;">
             <span class="material-symbols-outlined">close</span>
        </button>
        
        <h3>Rekap Member Baru</h3>
        
        <div id="rekap-filter" class="stats-filter">
            <button class="active" data-period="today">Hari Ini</button>
            <button data-period="week">Minggu Ini</button>
            <button data-period="month">Bulan Ini</button>
        </div>

        <ul id="rekap-member-list"></ul>
        
        <button id="share-rekap-wa-btn" class="btn" style="margin-top:20px;">
            <span class="material-symbols-outlined">share</span>
            <span class="btn-text">Share Laporan ke WhatsApp</span>
        </button>
        
    </div>
</div>

<div id="edit-member-overlay" class="overlay">
    <div class="overlay-content">
        <h3>Edit Data Member</h3>
        <form id="edit-member-form">
            <input type="hidden" id="edit-member-id">
            <div class="form-group"><label for="edit-nama">Nama Lengkap</label><input type="text" id="edit-nama" required></div>
            <div class="form-group"><label for="edit-alamat">Alamat</label><input type="text" id="edit-alamat" required></div>
            <div class="form-group"><label for="edit-nomor-hp">Nomor HP</label><input type="tel" id="edit-nomor-hp" readonly disabled></div>
            <div class="form-group"><label for="edit-tanggal-lahir">Tanggal Lahir</label><input type="date" id="edit-tanggal-lahir" required></div>
            <div class="form-group">
                <label for="edit-sumber-info">Tahu Resto dari Mana?</label>
                <select id="edit-sumber-info" required>
                    <option value="">-- Pilih --</option>
                    <option>Instagram</option><option>Tiktok</option><option>Teman/Keluarga</option><option>Lainnya</option>
                </select>
            </div>
             <div class="form-group">
                <label for="edit-instagram">Username Instagram</label>
                <input type="text" id="edit-instagram" placeholder="Username Instagram">
            </div>
            <div class="form-group">
                <label for="edit-tiktok">Username TikTok</label>
                <input type="text" id="edit-tiktok" placeholder="Username TikTok">
            </div>
            <div class="form-group"><label for="edit-poin">Poin</label><input type="number" id="edit-poin" required></div>
             <div class="form-group"><label for="edit-sisa-pembelanjaan">Sisa Pembelanjaan (Rp)</label><input type="number" id="edit-sisa-pembelanjaan" required></div>
            <button type="submit" class="btn btn-primary">
                <span class="btn-text">Update Data</span>
                <span class="material-symbols-outlined">save</span>
                <span class="spinner"></span>
            </button>
            <button type="button" id="cancel-edit-btn" class="btn btn-secondary" style="margin-top:10px;">
                <span class="btn-text">Batal</span>
            </button>
        </form>
    </div>
</div>

<div id="transaction-history-overlay" class="overlay">
    <div class="overlay-content">
        <button id="close-history-btn" class="btn btn-secondary" style="width:auto; margin-bottom:20px;">
            <span class="material-symbols-outlined">close</span>
        </button>
        <h3>Riwayat Transaksi</h3>
        <p style="text-align:center; font-size: 1.1em; margin-top:-15px; margin-bottom:20px;">
            Member: <strong id="history-member-name">-</strong>
        </p>
        <ul id="history-list" class="data-list" style="max-height: 50vh; overflow-y: auto;">
            </ul>
    </div>
</div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, collection, getDocs, deleteDoc, updateDoc, increment, runTransaction, serverTimestamp, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAEzWDI9ZWlc7NnUTDBbx7wednnUVeS9Ao",
        authDomain: "member-hp-dolansawah.firebaseapp.com",
        projectId: "member-hp-dolansawah",
        storageBucket: "member-hp-dolansawah.appspot.com",
        messagingSenderId: "277683917105",
        appId: "1:277683917105:web:d496ee4547f339e2fee010"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    let allPointRewards = [];
    let allBirthdayRewards = [];
    let topMemberRewardName = null;
    let currentMemberId = null;
    let currentMemberData = {};
    let allMembers = [], allTransactions = [], allRedemptions = [];
    let fullMemberList = [];
    let infoSourceChart = null;
    
    // State untuk fitur Share Laporan
    let currentRekapData = []; 
    let currentRekapPeriodLabel = 'Hari Ini';

    const POIN_THRESHOLD = 100000;

    // DOM Elements
    const memberDetailOverlay   = document.getElementById('member-detail-overlay');
    const backToSearchBtn       = document.getElementById('back-to-search-btn');
    const allMembersOverlay     = document.getElementById('all-members-overlay');
    const editMemberOverlay     = document.getElementById('edit-member-overlay');
    const birthdayNotification  = document.getElementById('birthday-notification');
    const rekapMemberOverlay    = document.getElementById('rekap-member-overlay');
    const adminLoginView        = document.getElementById('admin-login-view');
    const adminContentView      = document.getElementById('admin-content-view');
    const globalLoader          = document.getElementById('global-loader');
    const transactionHistoryOverlay = document.getElementById('transaction-history-overlay');
    const closeHistoryBtn       = document.getElementById('close-history-btn');

    // --- UTILITIES ---
    const showLoading = (button, isLoading) => {
        if (!button) return;
        button.disabled = isLoading;
        button.classList.toggle('loading', isLoading);
    };

    const showStatus = (message, isError = false, targetElementId = 'status-message') => {
        const div = document.getElementById(targetElementId);
        if (!div) return;
        div.textContent = message;
        div.className = '';
        div.classList.add(isError ? 'error' : 'success', 'visible');
        setTimeout(() => {
            div.classList.remove('visible','success','error');
            div.textContent = '';
        }, 3500);
    };

    const formatPhoneNumber = (phoneNumber) => {
        const s = (phoneNumber || '').replace(/\D/g, '');
        if (s.startsWith('08')) return '62' + s.substring(1);
        if (s.startsWith('62')) return s;
        if (s.startsWith('8')) return '62' + s;
        return s;
    };
    
    const formatCurrency = (number) => {
        return new Intl.NumberFormat('id-ID').format(number || 0);
    };
    
    const formatTimestamp = (date) => {
        if (!date) return '-';
        return date.toLocaleString('id-ID', {
            day: '2-digit', month: 'short', year: '2-digit',
            hour: '2-digit', minute: '2-digit'
        });
    };

    const getBirthdayReward = (memberTanggalLahir) => {
        if (!memberTanggalLahir) return null;
        const today = new Date();
        const birthdate = new Date(memberTanggalLahir);
        if (today.getMonth() === birthdate.getMonth() && today.getDate() === birthdate.getDate()) {
            return allBirthdayRewards.length > 0 ? allBirthdayRewards[0].name : null;
        }
        return null;
    };

    const parseCityFromAddress = (address) => {
        if (!address || typeof address !== 'string') return 'Tidak Diketahui';
        const parts = address.split(',').map(p => p.trim());
        if (parts.length > 1) {
            let city = parts[parts.length - 2];
            city = city.replace(/^(Kota|Kabupaten|Kab\.)\s*/i, '');
            return city.charAt(0).toUpperCase() + city.slice(1);
        }
        if (parts.length === 1 && parts[0] !== '') {
             let city = parts[0];
             city = city.replace(/^(Kota|Kabupaten|Kab\.)\s*/i, '');
             return city.charAt(0).toUpperCase() + city.slice(1);
        }
        return 'Tidak Diketahui';
    };

    // --- STATS & CHARTS ---
    const renderAddressStats = (addressCounts) => {
        const listEl = document.getElementById('address-stats-list');
        listEl.innerHTML = '';
        const sortedAddresses = Object.entries(addressCounts).sort(([, a], [, b]) => b - a);
        if (sortedAddresses.length === 0) {
            listEl.innerHTML = '<li>Tidak ada data pengunjung untuk periode ini.</li>';
            return;
        }
        sortedAddresses.forEach(([address, count]) => {
            const li = document.createElement('li');
            li.className = 'data-list-item';
            li.innerHTML = `<span><strong>${address}</strong></span><span>${count} pengunjung</span>`;
            listEl.appendChild(li);
        });
    };
    
    const updateAddressStats = (visitingMemberIds) => {
        const memberAddressMap = new Map(allMembers.map(m => [m.nomorHp, m.alamat]));
        const addressCounts = {};
        visitingMemberIds.forEach(memberId => {
            const address = memberAddressMap.get(memberId);
            const city = parseCityFromAddress(address);
            addressCounts[city] = (addressCounts[city] || 0) + 1;
        });
        renderAddressStats(addressCounts);
    };

    const updateInfoSourceList = (sourceCounts) => {
        const listEl = document.getElementById('info-source-list');
        listEl.innerHTML = '';
        Object.entries(sourceCounts).forEach(([source,count])=>{
            const li = document.createElement('li');
            li.className = 'data-list-item';
            li.innerHTML = `<span><strong>${source}</strong></span><span>${count} member</span>`;
            listEl.appendChild(li);
        });
    };

    const initializeChart = () => {
        const ctx = document.getElementById('info-source-chart').getContext('2d');
        if (infoSourceChart) infoSourceChart.destroy();
        infoSourceChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: [], datasets: [{ label:'Sumber Info', data: [], backgroundColor: ['#00796B','#F57C00','#4CAF50','#FFC107','#2196F3','#8e44ad','#2ecc71'], hoverOffset:4 }] },
            options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
        });
    };

    const updateInfoSourceChart = () => {
        const sourceCounts = allMembers.reduce((acc, member) => {
            const source = member.sumberInfo || 'Tidak Diketahui';
            acc[source] = (acc[source] || 0) + 1;
            return acc;
        }, {});
        const labels = Object.keys(sourceCounts);
        const data   = Object.values(sourceCounts);
        if (infoSourceChart){
            infoSourceChart.data.labels = labels;
            infoSourceChart.data.datasets[0].data = data;
            infoSourceChart.update();
        }
        updateInfoSourceList(sourceCounts);
    };

    // --- NAVIGATION & UI SETUP ---
    const setupNavigation = () => {
        document.querySelectorAll('.nav-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const targetId = button.id.replace('nav-','') + '-section';
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.toggle('active', section.id === targetId);
                });
                if (targetId === 'admin-section' && auth.currentUser) {
                    updateStatsUI('today');
                }
            });
        });
    };
    
    const setupAdminTabs = () => {
        const adminNav = document.querySelector('.admin-nav');
        adminNav.addEventListener('click', e => {
            const button = e.target.closest('.admin-nav-button');
            if (!button) return;

            adminNav.querySelectorAll('.admin-nav-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.admin-tab-pane').forEach(pane => pane.classList.remove('active'));

            const targetId = button.dataset.target;
            button.classList.add('active');
            document.getElementById(targetId)?.classList.add('active');
        });
    };

    const renderList = (listId, items, nameField, pointsField = null) => {
        const listEl = document.getElementById(listId);
        if (!listEl) return;
        if (!items.length){
            listEl.innerHTML = `<li>Belum ada reward ditambahkan.</li>`;
            return;
        }
        listEl.innerHTML = items.map(item => `
            <li>
                <span><strong>${item[nameField]}</strong>${pointsField ? ` - ${item[pointsField]} Poin` : ''}</span>
                <button class="btn btn-danger delete-reward-btn" data-id="${item.id}" data-type="${pointsField ? 'points' : 'birthday'}">
                    <span class="btn-text">Hapus</span>
                    <span class="spinner"></span>
                </button>
            </li>
        `).join('');
    };

    // --- DATA FETCHING ---
    const fetchPointRewards = async () => {
        try{
            const snapshot = await getDocs(collection(db,"rewards"));
            allPointRewards = snapshot.docs.map(d => ({ id:d.id, ...d.data() }));
            renderList('point-reward-list', allPointRewards, 'name', 'points');
        }catch(err){ console.error("Gagal memuat reward poin:", err); }
    };

    const fetchBirthdayRewards = async () => {
        try{
            const snapshot = await getDocs(collection(db,"birthdayRewards"));
            allBirthdayRewards = snapshot.docs.map(d => ({ id:d.id, ...d.data() }));
            renderList('birthday-reward-list', allBirthdayRewards, 'name');
        }catch(err){ console.error("Gagal memuat reward ultah:", err); }
    };

    const fetchTopMemberReward = async () => {
        try {
            const docRef = doc(db, "settings", "topMemberReward");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                topMemberRewardName = docSnap.data().name;
                document.getElementById('current-top-member-reward').textContent = topMemberRewardName;
                document.getElementById('top-member-reward-name').value = topMemberRewardName;
            } else {
                document.getElementById('current-top-member-reward').textContent = "Belum diatur.";
            }
        } catch (err) {
            console.error("Gagal memuat reward top 5:", err);
        }
    };

    const fetchAllStatsData = async () => {
        try{
            const [membersSnap, transactionsSnap, redemptionsSnap] = await Promise.all([
                getDocs(collection(db,"members")),
                getDocs(collection(db,"transactions")),
                getDocs(collection(db,"redemptions"))
            ]);
            allMembers = membersSnap.docs.map(d => ({ id:d.id, ...d.data(), tanggalDaftar: d.data().tanggalDaftar?.toDate?.() || new Date(d.data().tanggalDaftar) }));
            allTransactions = transactionsSnap.docs.map(d => ({ id:d.id, ...d.data(), tanggal: d.data().tanggal?.toDate?.() || new Date(d.data().tanggal) }));
            allRedemptions = redemptionsSnap.docs.map(d => ({ id:d.id, ...d.data(), tanggal: d.data().tanggal?.toDate?.() || new Date(d.data().tanggal) }));
        }catch(err){
            console.error("Gagal mengambil data statistik:", err);
            showStatus("Gagal memuat data statistik.", true);
        }
    };

    const getDateRange = (period) => {
        const now = new Date();
        const start = new Date(now), end = new Date(now);
        if (period === 'today'){
            start.setHours(0,0,0,0); end.setHours(23,59,59,999);
        }else if (period === 'week'){
            const day = (now.getDay() + 6) % 7;
            start.setDate(now.getDate() - day);
            start.setHours(0,0,0,0);
            end.setTime(start.getTime() + 6*24*60*60*1000);
            end.setHours(23,59,59,999);
        }else if (period === 'month'){
            start.setDate(1); start.setHours(0,0,0,0);
            end.setMonth(now.getMonth()+1,0); end.setHours(23,59,59,999);
        }
        return { start, end };
    };

    const updateStatsUI = (period) => {
        let filteredMembers = allMembers;
        let filteredTransactions = allTransactions;
        let filteredRedemptions = allRedemptions;
        if (period !== 'all'){
            const { start, end } = getDateRange(period);
            filteredMembers = allMembers.filter(m => m.tanggalDaftar >= start && m.tanggalDaftar <= end);
            filteredTransactions = allTransactions.filter(t => t.tanggal >= start && t.tanggal <= end);
            filteredRedemptions = allRedemptions.filter(r => r.tanggal >= start && r.tanggal <= end);
        }
        const visitingMemberIds = new Set(filteredTransactions.map(t => t.memberId));

        document.getElementById('stat-total-members').textContent   = allMembers.length;
        document.getElementById('stat-new-members').textContent     = filteredMembers.length;
        document.getElementById('stat-visiting-members').textContent= visitingMemberIds.size;
        document.getElementById('stat-redeemed-rewards').textContent= filteredRedemptions.length;

        updateInfoSourceChart();
        updateAddressStats(visitingMemberIds);
    };

    // --- LOGIC: MEMBER MANAGEMENT & DISPLAY ---
    const loadAndRenderAllMembers = async () => {
        const listEl = document.getElementById('all-members-list');
        listEl.innerHTML = '<li>Memuat data...</li>';
        try{
            const membersSnap = await getDocs(collection(db,"members"));
            fullMemberList = membersSnap.docs.map(d => ({ id:d.id, ...d.data() }));
            renderMemberList(fullMemberList);
        }catch(err){
            listEl.innerHTML = '<li>Gagal memuat data. Silakan coba lagi.</li>';
            throw err;
        }
    };

    const renderMemberList = (membersToRender) => {
        const listEl = document.getElementById('all-members-list');
        if (!membersToRender.length){
            listEl.innerHTML = '<li>Tidak ada member yang cocok dengan pencarian.</li>';
            return;
        }
        listEl.innerHTML = membersToRender.map(member => `
            <li class="member-list-item" id="member-item-${member.id}">
                <div class="member-list-item-info">
                    <strong>${member.nama}</strong>
                    <span>${member.nomorHp}</span>
                </div>
                <div class="member-list-item-actions">
                    <button class="btn btn-secondary view-history-btn" data-id="${member.id}" data-name="${member.nama}" style="background-color: var(--primary-light); color: white;">Riwayat</button>
                    <button class="btn btn-info edit-member-btn" data-id="${member.id}">Edit</button>
                    <button class="btn btn-danger delete-member-btn" data-id="${member.id}" data-name="${member.nama}">Hapus</button>
                </div>
            </li>
        `).join('');
    };

    const displayClaimableRewards = (memberPoints) => {
        const container = document.getElementById('claimable-rewards');
        const affordableRewards = allPointRewards.filter(r => (r.points || 0) <= (memberPoints || 0));
        container.innerHTML = affordableRewards.length > 0
            ? `<h4>Reward yang Bisa Diklaim:</h4>` + affordableRewards.map(r => `
                <div class="reward-item">
                    <span><strong>${r.name}</strong> (${r.points} Poin)</span>
                    <button class="btn btn-secondary redeem-btn" data-name="${r.name}" data-points="${r.points}">
                        <span class="btn-text">Redeem</span>
                        <span class="material-symbols-outlined">redeem</span>
                        <span class="spinner"></span>
                    </button>
                </div>
              `).join('')
            : '<h4>Reward yang Bisa Diklaim:</h4><p>Poin belum cukup untuk menukar reward.</p>';
    };

    // --- REKAP & WHATSAPP LOGIC (FIXED) ---
    const renderRekapMemberList = (membersToRender) => {
        // Simpan data untuk Share WA
        currentRekapData = membersToRender;

        const listEl = document.getElementById('rekap-member-list');
        const shareBtn = document.getElementById('share-rekap-wa-btn');

        if (!membersToRender.length) {
            listEl.innerHTML = '<li style="text-align:center; color:#777; padding:20px;">Tidak ada member baru pada periode ini.</li>';
            shareBtn.style.display = 'none';
            return;
        }

        shareBtn.style.display = 'flex';
        
        listEl.innerHTML = membersToRender.map(member => {
            const waNumber = formatPhoneNumber(member.nomorHp);
            const isVerified = member.isVerified !== false;
            const instagramUser = (member.instagram || '-').replace('@','');
            const tiktokUser = (member.tiktok || '-').replace('@','');
            const joinDate = formatTimestamp(member.tanggalDaftar);

            return `
                <li class="rekap-card ${isVerified ? 'verified' : 'unverified'}" id="rekap-item-${member.id}">
                    <div class="rekap-card-header">
                        <div>
                            <span class="rekap-name">${member.nama}</span>
                            <span class="rekap-phone">
                                <span class="material-symbols-outlined" style="font-size:14px;">call</span> 
                                ${member.nomorHp}
                            </span>
                        </div>
                        <span class="rekap-status-badge ${isVerified ? 'v' : 'u'}">
                            ${isVerified ? 'Verified' : 'Unverified'}
                        </span>
                    </div>
                    
                    <div class="rekap-card-body">
                        <div class="rekap-row">
                            <span class="rekap-label">Tgl Daftar:</span>
                            <span class="rekap-val">${joinDate} WIB</span>
                        </div>
                        <div class="rekap-row">
                            <span class="rekap-label">Sumber:</span>
                            <span class="rekap-val">${member.sumberInfo || '-'}</span>
                        </div>
                        <div class="rekap-row">
                            <span class="rekap-label">Sosmed:</span>
                            <span class="rekap-val">
                                ${instagramUser !== '-' ? `<span style="color:#E1306C">IG: ${instagramUser}</span> ` : ''}
                                ${tiktokUser !== '-' ? `<span style="color:#000">TT: ${tiktokUser}</span>` : ''}
                                ${instagramUser === '-' && tiktokUser === '-' ? '-' : ''}
                            </span>
                        </div>
                    </div>

                    <div class="rekap-card-footer">
                        <a href="https://wa.me/${waNumber}" target="_blank" class="btn btn-mini-action wa-direct">
                            Chat WA
                        </a>
                         <button class="btn btn-mini-action ${isVerified ? 'btn-warning' : 'btn-primary'} toggle-verify-btn" data-id="${member.id}" data-verified="${isVerified}">
                           ${isVerified ? 'Batal Verifikasi' : 'Verifikasi Member'}
                        </button>
                    </div>
                </li>
            `;
        }).join('');
    };

    const generateWhatsAppReport = () => {
        if (!currentRekapData || currentRekapData.length === 0) {
            showStatus("Tidak ada data untuk dibagikan.", true);
            return;
        }

        const now = new Date();
        const tglLaporan = now.toLocaleString('id-ID', { dateStyle: 'full' });

        // Header Laporan
        let message = ` *LAPORAN MEMBER BARU DOLAN SAWAH*\n`;
        message += ` *Periode:* ${currentRekapPeriodLabel}\n`;
        message += ` *Tanggal Cetak:* ${tglLaporan}\n`;
        message += ` *Total:* ${currentRekapData.length} Member Baru\n`;
        message += `--------------------------------\n\n`;

        // Loop Data Member
        currentRekapData.forEach((member, index) => {
            const ig = member.instagram ? member.instagram : '-';
            const tt = member.tiktok ? member.tiktok : '-';
            const sumber = member.sumberInfo || '-';
            const tglDaftar = formatTimestamp(member.tanggalDaftar);
            const statusVerif = member.isVerified ? ' VERIFIED' : ' UNVERIFIED';

            message += `*${index + 1}. ${member.nama.toUpperCase()}*\n`;
            message += `    WA: ${member.nomorHp}\n`;
            message += `    Status: ${statusVerif}\n`;
            message += `    Join: ${tglDaftar}\n`;
            message += `    Info: ${sumber}\n`;
            if(ig !== '-') message += `    IG: ${ig}\n`;
            if(tt !== '-') message += `    TT: ${tt}\n`;
            message += `\n`;
        });

        message += `--------------------------------\n`;
        message += ` *Data Digenerate Otomatis oleh Sistem*`;

        const encodedMessage = encodeURIComponent(message);
        window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
    };


    // --- EVENT LISTENERS (MAIN) ---
    document.addEventListener('DOMContentLoaded', async () => {
        globalLoader.classList.add('visible');
        setupNavigation();
        setupAdminTabs(); 
        
        closeHistoryBtn.addEventListener('click', () => {
            transactionHistoryOverlay.classList.remove('visible');
        });

        // Event Listener Tombol Share WA
        document.getElementById('share-rekap-wa-btn').addEventListener('click', generateWhatsAppReport);

        onAuthStateChanged(auth, user => {
            if (user) {
                adminLoginView.style.display = 'none';
                adminContentView.style.display = 'block';
                if (document.getElementById('nav-admin').classList.contains('active')) {
                   updateStatsUI('today');
                }
            } else {
                adminLoginView.style.display = 'block';
                adminContentView.style.display = 'none';
            }
        });
        
        document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            showLoading(button, true);
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                let message = "Login gagal. Periksa koneksi internet Anda.";
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    message = "Email atau password yang Anda masukkan salah.";
                }
                showStatus(message, true, 'admin-login-status');
            } finally {
                showLoading(button, false);
            }
        });
        
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                showStatus("Anda berhasil logout.");
                document.getElementById('nav-search').click();
            } catch (error) {
                showStatus("Gagal untuk logout.", true);
            }
        });

        document.getElementById('search-form').addEventListener('submit', async e => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            showLoading(button, true);
            try{
                const nomorHp = document.getElementById('search-hp').value.trim();
                if (!nomorHp) throw new Error("Nomor HP harus diisi.");
                const docRef  = doc(db,"members", nomorHp);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()){
                    currentMemberData = docSnap.data();
                    currentMemberId = currentMemberData.nomorHp;

                    document.getElementById('info-nama').textContent = currentMemberData.nama;
                    document.getElementById('info-poin').textContent = currentMemberData.poin || 0;
                    document.getElementById('info-sisa').textContent = formatCurrency(currentMemberData.sisaPembelanjaan);
                    
                    displayClaimableRewards(currentMemberData.poin || 0);

                    const birthdayRewardName = getBirthdayReward(currentMemberData.tanggalLahir);
                    const waBase = `https://wa.me/${formatPhoneNumber(currentMemberData.nomorHp)}`;
                    if (birthdayRewardName){
                        birthdayNotification.textContent = ` Selamat ulang tahun! Member ini berhak mendapatkan reward spesial: ${birthdayRewardName}.`;
                        birthdayNotification.classList.add('show');
                        document.getElementById('whatsapp-member-btn').href = `${waBase}?text=${encodeURIComponent(`Halo ${currentMemberData.nama}, selamat ulang tahun! Dolan Sawah punya penawaran spesial untukmu: *${birthdayRewardName}*. Langsung datang ke resto dan tukar reward spesialmu! `)}`;
                    }else{
                        birthdayNotification.classList.remove('show');
                        document.getElementById('whatsapp-member-btn').href = waBase;
                    }
                    memberDetailOverlay.classList.add('visible');
                    document.getElementById('transaction-amount').focus();
                }else{
                    showStatus(`Member dengan No. HP ${nomorHp} tidak ditemukan.`, true);
                }
            }catch(err){
                showStatus(err.message || "Terjadi kesalahan.", true);
            }finally{
                showLoading(button, false);
            }
        });

        document.getElementById('register-form').addEventListener('submit', async e => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            showLoading(button, true);
            const form = e.target;
            const nomorHp = form.querySelector('#nomor-hp').value.trim();
            try{
                const docRef  = doc(db,"members", nomorHp);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) throw new Error("Nomor HP ini sudah terdaftar sebagai member.");
                
                await setDoc(docRef, {
                    nama: form.querySelector('#nama').value,
                    alamat: form.querySelector('#alamat').value,
                    nomorHp,
                    tanggalLahir: form.querySelector('#tanggal-lahir').value,
                    sumberInfo: form.querySelector('#sumber-info').value,
                    instagram: form.querySelector('#instagram').value.trim(),
                    tiktok: form.querySelector('#tiktok').value.trim(),
                    isVerified: true,
                    poin: 0,
                    sisaPembelanjaan: 0,
                    tanggalDaftar: serverTimestamp()
                });

                showStatus("Member baru berhasil didaftarkan!");
                form.reset();
                await fetchAllStatsData();
                document.getElementById('nav-search').click();
                document.getElementById('search-hp').value = nomorHp;
                document.querySelector('#search-form button[type="submit"]').click();
                
            }catch(err){
                if(err.message.includes("sudah terdaftar")){
                    showStatus("Gagal: Nomor HP ini sudah terdaftar. Silakan gunakan nomor lain.", true);
                } else {
                    showStatus(err.message || "Gagal mendaftar.", true);
                }
            }finally{
                showLoading(button, false);
            }
        });

        document.getElementById('add-transaction-form').addEventListener('submit', async e => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            const amountInput = document.getElementById('transaction-amount');
            const amount = parseInt(amountInput.value, 10);
            if (!amount || !currentMemberId || amount <= 0) {
                showStatus("Masukkan nominal transaksi yang valid.", true, 'transaction-status');
                return;
            }
            showLoading(button, true);
            const memberDocRef = doc(db, "members", currentMemberId);

            try {
                let pointsGained = 0;
                let newRemainder = 0;
                
                await runTransaction(db, async (transaction) => {
                    const memberDoc = await transaction.get(memberDocRef);
                    if (!memberDoc.exists()) throw new Error("Member tidak ditemukan.");

                    const data = memberDoc.data();
                    const oldRemainder = data.sisaPembelanjaan || 0;
                    const totalForPoints = amount + oldRemainder;
                    
                    pointsGained = Math.floor(totalForPoints / POIN_THRESHOLD);
                    newRemainder = totalForPoints % POIN_THRESHOLD;

                    transaction.update(memberDocRef, {
                        poin: increment(pointsGained),
                        sisaPembelanjaan: newRemainder
                    });
                });
                
                await addDoc(collection(db, "transactions"), { 
                    memberId: currentMemberId, 
                    nominal: amount, 
                    poinDidapat: pointsGained,
                    tanggal: serverTimestamp()
                });
                
                const newPointsTotal = (currentMemberData.poin || 0) + pointsGained;
                currentMemberData.poin = newPointsTotal;
                currentMemberData.sisaPembelanjaan = newRemainder;
                document.getElementById('info-poin').textContent = newPointsTotal;
                document.getElementById('info-sisa').textContent = formatCurrency(newRemainder);
                displayClaimableRewards(newPointsTotal);
                showStatus(`Transaksi berhasil! Member mendapat ${pointsGained} poin.`, false, 'transaction-status');
                e.target.reset();
                await fetchAllStatsData();

            } catch (err) {
                showStatus(err.message || "Gagal menyimpan transaksi.", true, 'transaction-status');
            } finally {
                showLoading(button, false);
            }
        });

        document.getElementById('member-detail-overlay').addEventListener('click', async e => {
            const button = e.target.closest('.redeem-btn');
            if (!button) return;
            const { name, points } = button.dataset;
            const pointsCost = parseInt(points, 10);
            if (!confirm(`Tukar ${pointsCost} poin dengan "${name}"? Poin member akan dikurangi.`)) return;
            showLoading(button, true);
            try{
                const memberDocRef = doc(db,"members", currentMemberId);
                await updateDoc(memberDocRef, { poin: increment(-pointsCost) });
                await addDoc(collection(db,"redemptions"), { memberId: currentMemberId, rewardName: name, pointsSpent: pointsCost, tanggal: serverTimestamp() });

                const newPoints = Math.max(0, (currentMemberData.poin || 0) - pointsCost);
                currentMemberData.poin = newPoints;
                document.getElementById('info-poin').textContent = newPoints;
                displayClaimableRewards(newPoints);
                showStatus(`Poin berhasil ditukar dengan ${name}!`, false, 'transaction-status');
                await fetchAllStatsData();
            }catch(err){
                showStatus("Gagal menukar poin.", true, 'transaction-status');
            }finally{
                showLoading(button, false);
            }
        });

        backToSearchBtn.addEventListener('click', () => {
            memberDetailOverlay.classList.remove('visible');
            document.getElementById('search-form').reset();
            document.getElementById('search-hp').focus();
            birthdayNotification.classList.remove('show');
        });
        
        const adminSection = document.getElementById('admin-section');
        adminSection.addEventListener('submit', async e => {
            e.preventDefault();
            if (e.target.id === 'add-point-reward-form') {
                const button = e.target.querySelector('button');
                showLoading(button, true);
                try {
                    const name = document.getElementById('reward-name').value.trim();
                    const points = parseInt(document.getElementById('reward-points').value, 10);
                    if (!name || !points || points < 0) throw new Error("Nama dan Poin Reward harus diisi dengan valid.");
                    await addDoc(collection(db, "rewards"), { name, points });
                    showStatus("Reward poin berhasil ditambahkan!");
                    e.target.reset();
                    await fetchPointRewards();
                } catch (err) { showStatus(err.message, true); } 
                finally { showLoading(button, false); }

            } else if (e.target.id === 'add-birthday-reward-form') {
                const button = e.target.querySelector('button');
                showLoading(button, true);
                try{
                    const name = document.getElementById('birthday-reward-name').value.trim();
                    if (!name) throw new Error("Nama Reward harus diisi.");
                    await addDoc(collection(db,"birthdayRewards"), { name });
                    showStatus("Reward ultah berhasil ditambahkan!");
                    e.target.reset();
                    await fetchBirthdayRewards();
                }catch(err){ showStatus(err.message, true); }
                finally{ showLoading(button, false); }
            
            } else if (e.target.id === 'save-top-member-reward-form') {
                const button = e.target.querySelector('button');
                showLoading(button, true);
                try {
                    const name = document.getElementById('top-member-reward-name').value.trim();
                    if (!name) throw new Error("Nama Reward harus diisi.");
                    await setDoc(doc(db, "settings", "topMemberReward"), { name: name }, { merge: true });
                    showStatus("Reward Top 5 berhasil disimpan!");
                    topMemberRewardName = name;
                    document.getElementById('current-top-member-reward').textContent = name;
                } catch (err) {
                    showStatus(err.message, true);
                } finally {
                    showLoading(button, false);
                }
            }
        });

        adminSection.addEventListener('click', async e => {
            const target = e.target;
            const deleteBtn = target.closest('.delete-reward-btn');
            if (deleteBtn) {
                if (!confirm("Yakin ingin menghapus reward ini?")) return;
                showLoading(deleteBtn, true);
                try {
                    const { id, type } = deleteBtn.dataset;
                    const collectionName = (type === 'points') ? 'rewards' : 'birthdayRewards';
                    await deleteDoc(doc(db, collectionName, id));
                    showStatus("Reward berhasil dihapus.");
                    (type === 'points') ? await fetchPointRewards() : await fetchBirthdayRewards();
                } catch (err) { showStatus("Gagal menghapus reward.", true); } 
                finally { showLoading(deleteBtn, false); }
            }
            if (target.parentElement.classList.contains('stats-filter') && target.tagName === 'BUTTON') {
                adminSection.querySelectorAll('.stats-filter button').forEach(b => b.classList.remove('active'));
                target.classList.add('active');
                updateStatsUI(target.dataset.period);
            }
            if (target.id === 'show-all-members-btn' || target.closest('#show-all-members-btn')) {
                globalLoader.classList.add('visible');
                try {
                    await loadAndRenderAllMembers();
                    allMembersOverlay.classList.add('visible');
                } catch (error) {
                    console.error("Gagal memuat semua member:", error);
                    showStatus("Gagal memuat data member. Silakan coba lagi.", true);
                } finally {
                    globalLoader.classList.remove('visible');
                }
            }
            if (target.id === 'rekap-member-baru-btn' || target.closest('#rekap-member-baru-btn')) {
                if (fullMemberList.length === 0) {
                     globalLoader.classList.add('visible');
                     try {
                         await loadAndRenderAllMembers();
                     } catch(err) {
                         showStatus("Gagal memuat data awal untuk rekap.", true);
                         globalLoader.classList.remove('visible');
                         return;
                     } finally {
                         globalLoader.classList.remove('visible');
                     }
                }
                showRekapData('today');
                rekapMemberOverlay.classList.add('visible');
            }
        });
        
        document.getElementById('close-all-members-btn').addEventListener('click', () => allMembersOverlay.classList.remove('visible'));
        document.getElementById('search-all-members-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = fullMemberList.filter(m => (m.nomorHp || '').toLowerCase().includes(term));
            renderMemberList(filtered);
        });

        
        document.getElementById('all-members-list').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const { id: memberId, name: memberName } = button.dataset;
            
            if (button.classList.contains('delete-member-btn')){
                if (!confirm(`Yakin ingin menghapus member "${memberName}" (${memberId})? Data tidak bisa dikembalikan.`)) return;
                try{
                    await deleteDoc(doc(db,"members", memberId));
                    document.getElementById(`member-item-${memberId}`)?.remove();
                    fullMemberList = fullMemberList.filter(m => m.id !== memberId);
                    await fetchAllStatsData();
                    showStatus("Member berhasil dihapus.");
                }catch(err){ showStatus("Gagal menghapus member.", true); }
            
            }else if (button.classList.contains('edit-member-btn')){
                const memberData = fullMemberList.find(m => m.id === memberId);
                if (memberData){
                    const form = document.getElementById('edit-member-form');
                    form.querySelector('#edit-member-id').value = memberData.id;
                    form.querySelector('#edit-nama').value = memberData.nama || '';
                    form.querySelector('#edit-alamat').value = memberData.alamat || '';
                    form.querySelector('#edit-nomor-hp').value = memberData.nomorHp || '';
                    form.querySelector('#edit-tanggal-lahir').value = memberData.tanggalLahir || '';
                    form.querySelector('#edit-sumber-info').value = memberData.sumberInfo || '';
                    form.querySelector('#edit-instagram').value = memberData.instagram || '';
                    form.querySelector('#edit-tiktok').value = memberData.tiktok || '';
                    form.querySelector('#edit-poin').value = memberData.poin || 0;
                    form.querySelector('#edit-sisa-pembelanjaan').value = memberData.sisaPembelanjaan || 0;
                    editMemberOverlay.classList.add('visible');
                }
            } else if (button.classList.contains('view-history-btn')) {
                globalLoader.classList.add('visible');
                document.getElementById('history-member-name').textContent = memberName;
                const historyListEl = document.getElementById('history-list');
                historyListEl.innerHTML = '<li>Memuat riwayat...</li>';

                try {
                    const transactionsRef = collection(db, "transactions");
                    const q = query(transactionsRef, where("memberId", "==", memberId));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        historyListEl.innerHTML = '<li>Tidak ada riwayat transaksi ditemukan.</li>';
                    } else {
                        const transactions = querySnapshot.docs.map(doc => {
                            const data = doc.data();
                            const txDate = data.tanggal ? data.tanggal.toDate() : new Date(0); 
                            return {
                                ...data,
                                jsDate: txDate
                            };
                        });

                        transactions.sort((a, b) => b.jsDate.getTime() - a.jsDate.getTime());

                        historyListEl.innerHTML = transactions.map(tx => {
                            return `
                                <li class="data-list-item">
                                    <span>
                                        <strong>Rp ${formatCurrency(tx.nominal)}</strong>
                                        <small>${formatTimestamp(tx.jsDate)}</small>
                                    </span>
                                    <strong style="color:var(--accent-color)">+${tx.poinDidapat} Poin</strong>
                                </li>
                            `;
                        }).join('');
                    }
                    transactionHistoryOverlay.classList.add('visible');

                } catch (err) {
                    console.error("Gagal memuat riwayat:", err);
                    showStatus("Gagal memuat riwayat transaksi.", true);
                } finally {
                    globalLoader.classList.remove('visible');
                }
            }
        });

        document.getElementById('cancel-edit-btn').addEventListener('click', () => editMemberOverlay.classList.remove('visible'));
        document.getElementById('edit-member-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            showLoading(button, true);
            const memberId = document.getElementById('edit-member-id').value;
            const updatedData = {
                nama: document.getElementById('edit-nama').value,
                alamat: document.getElementById('edit-alamat').value,
                tanggalLahir: document.getElementById('edit-tanggal-lahir').value,
                sumberInfo: document.getElementById('edit-sumber-info').value,
                instagram: document.getElementById('edit-instagram').value.trim(),
                tiktok: document.getElementById('edit-tiktok').value.trim(),
                poin: parseInt(document.getElementById('edit-poin').value,10) || 0,
                sisaPembelanjaan: parseInt(document.getElementById('edit-sisa-pembelanjaan').value,10) || 0
            };
            try{
                await updateDoc(doc(db,"members", memberId), updatedData);
                editMemberOverlay.classList.remove('visible');
                await loadAndRenderAllMembers();
                await fetchAllStatsData();
                showStatus("Data member berhasil diupdate.");
            }catch(err){ showStatus("Gagal mengupdate data.", true); }
            finally{ showLoading(button, false); }
        });
        
        const showRekapData = (period) => {
            // Update Label Periode untuk Report
            if(period === 'today') currentRekapPeriodLabel = 'Hari Ini';
            else if(period === 'week') currentRekapPeriodLabel = 'Minggu Ini';
            else if(period === 'month') currentRekapPeriodLabel = 'Bulan Ini';

            const { start, end } = getDateRange(period);
            const data = (fullMemberList.length > 0 ? fullMemberList : allMembers).map(m => ({
                ...m,
                tanggalDaftar: m.tanggalDaftar?.toDate?.() || new Date(m.tanggalDaftar)
            }));
            const filtered = data.filter(m => m.tanggalDaftar >= start && m.tanggalDaftar <= end);
            renderRekapMemberList(filtered);
        };

        document.getElementById('close-rekap-btn').addEventListener('click', () => rekapMemberOverlay.classList.remove('visible'));
        document.getElementById('rekap-filter').addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') return;
            document.querySelectorAll('#rekap-filter button').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            showRekapData(e.target.dataset.period);
        });

        document.getElementById('rekap-member-list').addEventListener('click', async (e) => {
            const button = e.target.closest('.toggle-verify-btn');
            if (!button) return;
            const memberId = button.dataset.id;
            const newStatus = button.dataset.verified !== 'true';
            
            if(!confirm(`Apakah Anda yakin ingin mengubah status verifikasi member ini menjadi ${newStatus ? 'TERVERIFIKASI' : 'BELUM VERIFIKASI'}?`)) return;

            button.disabled = true;
            button.innerHTML = '<span class="spinner" style="display:block; width:16px; height:16px;"></span>';

            try {
                await updateDoc(doc(db, "members", memberId), { isVerified: newStatus });
                
                // Update data lokal
                const memberIndex = fullMemberList.findIndex(m => m.id === memberId);
                if (memberIndex > -1) fullMemberList[memberIndex].isVerified = newStatus;

                // --- FIX: Sinkronisasi data ke Variabel Report (PENTING) ---
                const rekapItem = currentRekapData.find(m => m.id === memberId);
                if(rekapItem) rekapItem.isVerified = newStatus;
                
                // Update Tampilan Card secara langsung
                const card = document.getElementById(`rekap-item-${memberId}`);
                if(card){
                    card.classList.remove('verified', 'unverified');
                    card.classList.add(newStatus ? 'verified' : 'unverified');
                    
                    const badge = card.querySelector('.rekap-status-badge');
                    badge.className = `rekap-status-badge ${newStatus ? 'v' : 'u'}`;
                    badge.textContent = newStatus ? 'Verified' : 'Unverified';

                    button.dataset.verified = newStatus;
                    button.className = `btn btn-mini-action ${newStatus ? 'btn-warning' : 'btn-primary'} toggle-verify-btn`;
                }

                showStatus("Status verifikasi berhasil diubah.");
            } catch (err) { 
                showStatus("Gagal mengubah status verifikasi.", true); 
            } finally { 
                button.disabled = false;
                button.innerHTML = newStatus ? 'Batal Verifikasi' : 'Verifikasi Member';
            }
        });

        try {
            await Promise.all([
                fetchPointRewards(),
                fetchBirthdayRewards(),
                fetchAllStatsData(),
                fetchTopMemberReward()
            ]);
            initializeChart();
            updateStatsUI('today');
        } catch (error) {
            showStatus("Gagal memuat data awal aplikasi. Periksa koneksi internet.", true);
        } finally {
            globalLoader.classList.remove('visible');
        }
    });
</script>
</body>
</html>