<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Member - Dolan Sawah</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0');

        :root{
            --primary-color:#00796B; --primary-light:#00897B; --accent-color:#F57C00; --accent-hover:#EF6C00;
            --bg-light:#F4F6F8; --bg-white:#FFFFFF; --text-dark:#333; --text-light:#FFF;
            --border-color:#E0E0E0; --shadow:0 4px 6px rgba(0,0,0,.1); --font-body:'Poppins',sans-serif;
            --danger-color:#d9534f; --danger-hover:#c9302c; --info-color:#5bc0de; --info-hover:#31b0d5;
            --warning-color:#f0ad4e; --warning-hover:#ec971f;
        }

        *{box-sizing:border-box}
        body{font-family:var(--font-body); background:var(--bg-light); color:var(--text-dark); margin:0; padding:20px}
        .container{width:100%; max-width:700px; margin:0 auto; background:var(--bg-white); border-radius:12px; box-shadow:var(--shadow); overflow:hidden}

        header{background:linear-gradient(135deg,var(--primary-light),var(--primary-color)); color:var(--text-light); padding:20px; text-align:center}
        header h1{margin:0; font-size:1.8em; font-weight:700}

        .nav{display:flex; background:#FDFDFD; border-bottom:1px solid var(--border-color)}
        .nav-button{flex:1; padding:15px; background:transparent; border:none; border-bottom:4px solid transparent; color:var(--text-dark); cursor:pointer; font-size:.95em; font-weight:600; transition:all .3s; opacity:.6}
        .nav-button:hover{opacity:1}
        .nav-button.active{opacity:1; color:var(--primary-color); border-bottom:4px solid var(--primary-color)}

        main{padding:25px}
        h2,h3,h4{color:var(--primary-color); text-align:center}
        h4{margin-top:25px; border-top:1px solid var(--border-color); padding-top:20px}

        .section{display:none}
        .section.active{display:block}

        .form-group{margin-bottom:16px}
        .form-group label{display:block; margin-bottom:8px; font-weight:500}
        .form-group input,.form-group select{width:100%; padding:12px; border:1px solid var(--border-color); border-radius:8px; font-size:1em}
        .form-group input:focus{border-color:var(--primary-color); outline:none}
        .form-group small {font-size: 0.8em; color: #777; margin-top: 4px; display: block;}


        .btn{width:100%; padding:15px; border:none; border-radius:8px; cursor:pointer; font-size:1.05em; font-weight:600; transition:all .3s; display:flex; justify-content:center; align-items:center; gap:8px}
        .btn .material-symbols-outlined{font-size:1.2em}
        .btn-primary{background:var(--accent-color); color:var(--text-light)}
        .btn-primary:hover{background:var(--accent-hover)}
        .btn-secondary{background:var(--bg-white); color:var(--accent-color); border:2px solid var(--accent-color); padding:13px}
        .btn-secondary:hover{background:var(--accent-color); color:var(--text-light)}
        .btn-danger{background:var(--danger-color); color:var(--text-light)}
        .btn-danger:hover{background:var(--danger-hover)}
        .btn-info{background:var(--info-color); color:var(--text-light)}
        .btn-info:hover{background:var(--info-hover)}
        .btn-warning{background:var(--warning-color); color:var(--text-light)}
        .btn-warning:hover{background:var(--warning-hover)}
        .btn:disabled{opacity:.7; cursor:not-allowed}

        .spinner{width:20px; height:20px; border:3px solid rgba(255,255,255,.3); border-top-color:var(--text-light); border-radius:50%; display:none; animation:spin 1s linear infinite}
        .btn-secondary .spinner{border-color:rgba(0,0,0,.2); border-top-color:var(--accent-color)}
        .btn.loading .btn-text{display:none}
        .btn.loading .spinner{display:block}
        @keyframes spin{to{transform:rotate(360deg)}}

        #status-message{padding:14px; margin-top:16px; border-radius:8px; opacity:0; visibility:hidden; transform:translateY(6px); transition:all .25s ease}
        #status-message.visible{opacity:1; visibility:visible; transform:translateY(0)}
        #status-message.success{background:#DFF0D8; color:#3C763D; border:1px solid #D6E9C6}
        #status-message.error{background:#F2DEDE; color:#A94442; border:1px solid #EBCCD1}

        .birthday-notification{padding:15px; background:#FFEB3B; color:#333; border:1px solid #FFC107; border-radius:8px; margin-bottom:20px; text-align:center; font-weight:600; display:none}
        .birthday-notification.show{display:block}

        .overlay{position:fixed; inset:0; background:rgba(0,0,0,.8); backdrop-filter:blur(8px); z-index:1000; display:flex; justify-content:center; align-items:center; padding:20px; opacity:0; visibility:hidden; transition:opacity .4s ease, visibility .4s ease}
        .overlay.visible{opacity:1; visibility:visible}
        .overlay-content{background:var(--bg-white); padding:20px; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.3); width:calc(100% - 40px); max-width:700px; max-height:90vh; overflow:auto; transform:scale(.96); transition:transform .3s cubic-bezier(.2,.8,.2,1)}
        .overlay.visible .overlay-content{transform:scale(1)}

        #back-to-search-btn{background:transparent; border:2px solid var(--primary-color); color:var(--primary-color); font-size:1em; padding:12px; margin-bottom:20px; width:auto}
        #back-to-search-btn:hover{background:var(--primary-color); color:var(--text-light)}

        .poin{font-weight:700; font-size:2.4em; color:var(--primary-color); display:block; text-align:center; margin-bottom:12px}

        #claimable-rewards h4{font-size:1.05em; color:var(--text-dark); text-align:left}
        .reward-item{display:flex; justify-content:space-between; align-items:center; padding:12px; border-radius:8px; margin-bottom:10px; background:#f7f7f7; border:1px solid var(--border-color); transition:all .2s}
        .reward-item:hover{background:#f0f0f0}
        .redeem-btn{padding:8px 16px; font-size:.9em; width:auto}

        .reward-list-container{list-style:none; padding:0}
        .reward-list-container li{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:12px; border-radius:8px; margin-bottom:8px; background:#F9F9F9; border:1px solid var(--border-color)}
        .delete-reward-btn{padding:8px 12px; font-size:.85em; width:auto}

        #member-detail-overlay h3{font-size:1.4em; margin-bottom:14px}
        #member-detail-overlay p{font-size:1.05em; margin-bottom:10px}
        #member-detail-overlay strong{font-weight:600}

        .reward-subsection.hidden{display:none}
        .btn-options{display:flex; flex-direction:column; gap:12px; margin-top:16px}
        .reward-subsection{margin-top:16px}

        /* STATISTIK & FILTER */
        .stats-filter{display:flex; justify-content:center; gap:10px; margin:8px 0 18px}
        .stats-filter button{background:var(--bg-white); color:var(--primary-color); border:2px solid var(--border-color); padding:8px 14px; border-radius:18px; font-weight:600; cursor:pointer; transition:all .25s}
        .stats-filter button.active,.stats-filter button:hover{background:var(--primary-color); color:var(--text-light); border-color:var(--primary-color)}

        .stats-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:12px}
        .stat-card{background:#FDFDFD; padding:16px; border-radius:12px; border:1px solid var(--border-color); text-align:center}
        .stat-card h4{margin:0 0 8px 0; font-size:1em; font-weight:600; color:var(--text-dark); border-top:none; padding-top:0}
        .stat-value{font-size:2.1em; font-weight:700; color:var(--accent-color); display:block}

        .chart-container{margin-top:20px; padding:16px; border-radius:12px; background:#FDFDFD; border:1px solid var(--border-color)}
        .chart-container h3{margin:0 0 12px 0}
        #info-source-chart{width:100% !important; height:320px !important; display:block}
        @media (max-width:480px){ #info-source-chart{height:260px !important} }

        .data-list{list-style:none; padding:0; margin-top:12px}
        .data-list-item{padding:10px 6px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center; font-size:.98em}
        .data-list-item:last-child{border-bottom:none}

        /* DAFTAR MEMBER & REKAP */
        #register-section .divider{border-top:1px dashed var(--border-color); margin:24px 0}
        #all-members-list, #rekap-member-list {list-style:none; padding:0; margin-top:10px}
        .member-list-item{display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:10px; padding:12px; border-radius:8px; margin-bottom:8px; background:#F9F9F9; border:1px solid var(--border-color)}
        .member-list-item-info{flex-grow:1}
        .member-list-item-info strong{display:block; font-size:1.05em; color:var(--text-dark)}
        .member-list-item-info span{color:#666}
        .member-list-item-actions{display:flex; gap:8px; width:100%; justify-content:flex-end; flex-wrap: wrap;}
        @media (min-width:500px){ .member-list-item-actions{width:auto} }
        .member-list-item-actions .btn{width:auto; padding:8px 14px; font-size:.9em}
        
        /* -- BARU: STYLE UNTUK REKAP -- */
        .verification-status { font-size: 0.8em; font-weight: bold; padding: 4px 8px; border-radius: 10px; color: var(--text-light); }
        .verification-status.unverified { background-color: var(--danger-color); }
        .verification-status.verified { background-color: var(--primary-color); }

        .rekap-member-item .member-list-item-info { width: 100%; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .rekap-member-item .member-list-item-actions .btn .material-symbols-outlined { font-size: 1.1em; }
    </style>
</head>
<body>
<div class="container">
    <header><h1>Sistem Member Dolan Sawah</h1></header>

    <div class="nav">
        <button id="nav-search" class="nav-button active">Cari Member</button>
        <button id="nav-register" class="nav-button">Daftar Member</button>
        <button id="nav-rewards" class="nav-button">Atur Reward</button>
        <button id="nav-stats" class="nav-button">Statistik</button>
    </div>

    <main>
        <section id="search-section" class="section active">
            <h2>Cari & Info Member</h2>
            <form id="search-form" autocomplete="off">
                <div class="form-group">
                    <label for="search-hp">Nomor HP Member</label>
                    <input type="tel" id="search-hp" placeholder="Contoh: 081234567890" required autofocus>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span class="btn-text">Cari Member</span>
                    <span class="material-symbols-outlined">search</span>
                    <span class="spinner"></span>
                </button>
            </form>
        </section>

        <section id="register-section" class="section">
            <h2>Pendaftaran Member Baru</h2>
            <form id="register-form">
                <div class="form-group"><label for="nama">Nama Lengkap</label><input type="text" id="nama" required></div>
                <div class="form-group"><label for="alamat">Alamat</label><input type="text" id="alamat" required></div>
                <div class="form-group"><label for="nomor-hp">Nomor HP Aktif</label><input type="tel" id="nomor-hp" placeholder="Contoh: 081234567890" required></div>
                <div class="form-group"><label for="tanggal-lahir">Tanggal Lahir</label><input type="date" id="tanggal-lahir" required></div>
                <div class="form-group">
                    <label for="sumber-info">Tahu Resto dari Mana?</label>
                    <select id="sumber-info" required>
                        <option value="">-- Pilih --</option>
                        <option>Instagram</option><option>Tiktok</option><option>Teman/Keluarga</option><option>Lainnya</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="instagram">Username Instagram (Opsional)</label>
                    <input type="text" id="instagram" placeholder="Contoh: dolansawah.resto">
                    <small>Cukup masukkan username, tanpa "@"</small>
                </div>
                <div class="form-group">
                    <label for="tiktok">Username TikTok (Opsional)</label>
                    <input type="text" id="tiktok" placeholder="Contoh: dolansawah.official">
                     <small>Cukup masukkan username, tanpa "@"</small>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span class="btn-text">Daftarkan Member</span>
                    <span class="material-symbols-outlined">person_add</span>
                    <span class="spinner"></span>
                </button>
            </form>

            <div class="divider"></div>
            <h4>Manajemen Member</h4>
            <div class="btn-options">
                 <button id="show-all-members-btn" class="btn btn-secondary">
                    <span class="btn-text">Lihat Semua Data Member</span>
                    <span class="material-symbols-outlined">group</span>
                </button>
                 <button id="rekap-member-baru-btn" class="btn btn-secondary">
                    <span class="btn-text">Rekap Member Baru</span>
                    <span class="material-symbols-outlined">history</span>
                </button>
                </div>
        </section>

        <section id="rewards-section" class="section">
            <h2>Pengaturan Reward</h2>
            <div id="reward-options" class="btn-options">
                <button id="btn-show-point-rewards" class="btn btn-primary">Atur Reward Poin</button>
                <button id="btn-show-birthday-rewards" class="btn btn-primary">Atur Reward Ulang Tahun</button>
            </div>

            <div id="point-rewards-container" class="reward-subsection hidden">
                <button class="btn btn-secondary back-to-reward-options">
                    <span class="btn-text">Kembali</span>
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <h3>Reward Poin</h3>
                <form id="add-point-reward-form">
                    <div class="form-group"><label for="reward-name">Nama Reward</label><input type="text" id="reward-name" placeholder="Contoh: Gratis Es Teh" required></div>
                    <div class="form-group"><label for="reward-points">Poin Dibutuhkan</label><input type="number" id="reward-points" placeholder="Contoh: 5" required></div>
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-text">Tambah Reward Poin</span><span class="spinner"></span>
                    </button>
                </form>
                <h4>Daftar Reward Poin Aktif</h4>
                <ul id="point-reward-list" class="reward-list-container"></ul>
            </div>

            <div id="birthday-rewards-container" class="reward-subsection hidden">
                <button class="btn btn-secondary back-to-reward-options">
                    <span class="btn-text">Kembali</span>
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <h3>Reward Spesial Ulang Tahun</h3>
                <form id="add-birthday-reward-form">
                    <div class="form-group"><label for="birthday-reward-name">Nama Reward</label><input type="text" id="birthday-reward-name" placeholder="Contoh: Potongan Spesial 15%" required></div>
                    <button type="submit" class="btn btn-primary"><span class="btn-text">Tambah Reward Ultah</span><span class="spinner"></span></button>
                </form>
                <h4>Daftar Reward Ultah Aktif</h4>
                <ul id="birthday-reward-list" class="reward-list-container"></ul>
            </div>
        </section>

        <section id="stats-section" class="section">
            <h2>Statistik Member</h2>
            <div class="stats-filter">
                <button class="active" data-period="today">Hari Ini</button>
                <button data-period="week">Minggu Ini</button>
                <button data-period="month">Bulan Ini</button>
                <button data-period="all">Semua</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card"><h4>Total Member</h4><span id="stat-total-members" class="stat-value">0</span></div>
                <div class="stat-card"><h4>Member Baru</h4><span id="stat-new-members" class="stat-value">0</span></div>
                <div class="stat-card"><h4>Member Datang</h4><span id="stat-visiting-members" class="stat-value">0</span></div>
                <div class="stat-card"><h4>Reward Ditukar</h4><span id="stat-redeemed-rewards" class="stat-value">0</span></div>
            </div>

            <div class="chart-container">
                <h3>Sumber Informasi Member</h3>
                <canvas id="info-source-chart"></canvas>
                <ul id="info-source-list" class="data-list"></ul>
            </div>
        </section>

        <div id="status-message"></div>
    </main>
</div>

<div id="member-detail-overlay" class="overlay">
    <div class="overlay-content">
        <button id="back-to-search-btn" class="btn">
            <span class="btn-text">Kembali ke Pencarian</span>
            <span class="material-symbols-outlined">arrow_back</span>
        </button>

        <div id="birthday-notification" class="birthday-notification"></div>

        <h3>Detail Member</h3>
        <p><strong>Nama:</strong> <span id="info-nama"></span></p>
        <p><strong>Poin Terkumpul:</strong> <span id="info-poin" class="poin"></span></p>
        <p style="text-align:center; margin-top:-10px; margin-bottom: 20px;"><strong>Akumulasi Belanja:</strong> Rp <span id="info-sisa">0</span></p>
        <div id="claimable-rewards"></div>

        <div class="btn-options">
            <a id="whatsapp-member-btn" href="#" target="_blank" class="btn btn-info">
                <span class="btn-text">Hubungi via WhatsApp</span>
                <span class="material-symbols-outlined">sms</span>
            </a>
        </div>

        <div id="transaction-form">
            <h4>Tambah Transaksi & Poin</h4>
            <form id="add-transaction-form">
                <div class="form-group">
                    <label for="transaction-amount">Nominal Transaksi (Rp)</label>
                    <input type="number" id="transaction-amount" placeholder="Contoh: 150000" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span class="btn-text">Simpan & Hitung Poin</span>
                    <span class="material-symbols-outlined">save</span>
                    <span class="spinner"></span>
                </button>
            </form>
        </div>
    </div>
</div>

<div id="password-prompt-overlay" class="overlay">
    <div class="overlay-content">
        <h3>Akses Terbatas</h3>
        <p style="text-align:center; color: var(--danger-color);"><strong>Peringatan:</strong> Demi keamanan, sangat disarankan untuk mengimplementasikan Firebase Authentication.</p>
        <form id="password-form">
            <div class="form-group">
                <label for="admin-password">Masukkan Password Admin</label>
                <input type="password" id="admin-password" required>
            </div>
            <button type="submit" class="btn btn-primary">
                <span class="btn-text">Buka</span>
                <span class="material-symbols-outlined">lock_open</span>
            </button>
            <button type="button" id="cancel-password-btn" class="btn btn-secondary" style="margin-top:10px;">
                <span class="btn-text">Batal</span>
            </button>
        </form>
    </div>
</div>

<div id="all-members-overlay" class="overlay">
    <div class="overlay-content">
        <button id="close-all-members-btn" class="btn btn-secondary" style="width:auto; margin-bottom:20px;">
            <span class="material-symbols-outlined">close</span>
        </button>
        <h3>Semua Data Member</h3>
        <div class="form-group">
            <input type="tel" id="search-all-members-input" placeholder="Cari berdasarkan nomor HP...">
        </div>
        <ul id="all-members-list"></ul>
    </div>
</div>

<div id="rekap-member-overlay" class="overlay">
    <div class="overlay-content">
        <button id="close-rekap-btn" class="btn btn-secondary" style="width:auto; margin-bottom:20px;">
             <span class="material-symbols-outlined">close</span>
        </button>
        <h3>Rekap Member Baru Terdaftar</h3>
        <div id="rekap-filter" class="stats-filter">
            <button class="active" data-period="today">Hari Ini</button>
            <button data-period="week">Minggu Ini</button>
            <button data-period="month">Bulan Ini</button>
        </div>
        <ul id="rekap-member-list"></ul>
    </div>
</div>
<div id="edit-member-overlay" class="overlay">
    <div class="overlay-content">
        <h3>Edit Data Member</h3>
        <form id="edit-member-form">
            <input type="hidden" id="edit-member-id">
            <div class="form-group"><label for="edit-nama">Nama Lengkap</label><input type="text" id="edit-nama" required></div>
            <div class="form-group"><label for="edit-alamat">Alamat</label><input type="text" id="edit-alamat" required></div>
            <div class="form-group"><label for="edit-nomor-hp">Nomor HP</label><input type="tel" id="edit-nomor-hp" readonly disabled></div>
            <div class="form-group"><label for="edit-tanggal-lahir">Tanggal Lahir</label><input type="date" id="edit-tanggal-lahir" required></div>
            <div class="form-group">
                <label for="edit-sumber-info">Tahu Resto dari Mana?</label>
                <select id="edit-sumber-info" required>
                    <option value="">-- Pilih --</option>
                    <option>Instagram</option><option>Tiktok</option><option>Teman/Keluarga</option><option>Lainnya</option>
                </select>
            </div>
             <div class="form-group">
                <label for="edit-instagram">Username Instagram</label>
                <input type="text" id="edit-instagram" placeholder="Username Instagram">
            </div>
            <div class="form-group">
                <label for="edit-tiktok">Username TikTok</label>
                <input type="text" id="edit-tiktok" placeholder="Username TikTok">
            </div>
            <div class="form-group"><label for="edit-poin">Poin</label><input type="number" id="edit-poin" required></div>
             <div class="form-group"><label for="edit-sisa-pembelanjaan">Sisa Pembelanjaan (Rp)</label><input type="number" id="edit-sisa-pembelanjaan" required></div>
            <button type="submit" class="btn btn-primary">
                <span class="btn-text">Update Data</span>
                <span class="material-symbols-outlined">save</span>
                <span class="spinner"></span>
            </button>
            <button type="button" id="cancel-edit-btn" class="btn btn-secondary" style="margin-top:10px;">
                <span class="btn-text">Batal</span>
            </button>
        </form>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, collection, getDocs, deleteDoc, updateDoc, increment, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyAEzWDI9ZWlc7NnUTDBbx7wednnUVeS9Ao",
        authDomain: "member-hp-dolansawah.firebaseapp.com",
        projectId: "member-hp-dolansawah",
        storageBucket: "member-hp-dolansawah.appspot.com",
        messagingSenderId: "277683917105",
        appId: "1:277683917105:web:d496ee4547f339e2fee010"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // --- GLOBAL STATE ---
    let allPointRewards = [];
    let allBirthdayRewards = [];
    let currentMemberId = null;
    let allMembers = [], allTransactions = [], allRedemptions = [];
    let fullMemberList = [];
    let infoSourceChart = null;
    const POIN_THRESHOLD = 100000;

    const memberDetailOverlay   = document.getElementById('member-detail-overlay');
    const backToSearchBtn       = document.getElementById('back-to-search-btn');
    const passwordPromptOverlay = document.getElementById('password-prompt-overlay');
    const allMembersOverlay     = document.getElementById('all-members-overlay');
    const editMemberOverlay     = document.getElementById('edit-member-overlay');
    const birthdayNotification  = document.getElementById('birthday-notification');
    // === PERUBAHAN 5: Deklarasi Variabel Overlay Rekap ===
    const rekapMemberOverlay = document.getElementById('rekap-member-overlay');


    // --- HELPERS ---
    const showLoading = (button, isLoading) => {
        if (!button) return;
        button.disabled = isLoading;
        button.classList.toggle('loading', isLoading);
    };

    const showStatus = (message, isError = false, targetElementId = 'status-message') => {
        const div = document.getElementById(targetElementId);
        if (!div) return;
        div.textContent = message;
        div.className = '';
        div.classList.add(isError ? 'error' : 'success', 'visible');
        setTimeout(() => {
            div.classList.remove('visible','success','error');
            div.textContent = '';
        }, 3500);
    };

    const closeAllOverlays = () => {
        document.querySelectorAll('.overlay').forEach(o => o.classList.remove('visible'));
    };

    const formatPhoneNumber = (phoneNumber) => {
        const s = (phoneNumber || '').replace(/\D/g, '');
        if (s.startsWith('08')) return '62' + s.substring(1);
        if (s.startsWith('62')) return s;
        if (s.startsWith('8')) return '62' + s;
        return s;
    };
    
    const formatCurrency = (number) => {
        return new Intl.NumberFormat('id-ID').format(number || 0);
    };

    const getBirthdayReward = (memberTanggalLahir) => {
        if (!memberTanggalLahir) return null;
        const today = new Date();
        const birthdate = new Date(memberTanggalLahir);
        if (today.getMonth() === birthdate.getMonth() && today.getDate() === birthdate.getDate()) {
            return allBirthdayRewards.length > 0 ? allBirthdayRewards[0].name : null;
        }
        return null;
    };

    const updateInfoSourceList = (sourceCounts) => {
        const listEl = document.getElementById('info-source-list');
        listEl.innerHTML = '';
        Object.entries(sourceCounts).forEach(([source,count])=>{
            const li = document.createElement('li');
            li.className = 'data-list-item';
            li.innerHTML = `<span><strong>${source}</strong></span><span>${count} member</span>`;
            listEl.appendChild(li);
        });
    };

    // --- NAV ---
    const setupNavigation = () => {
        document.querySelectorAll('.nav-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const targetId = button.id.replace('nav-','') + '-section';
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.toggle('active', section.id === targetId);
                });
                if (targetId === 'stats-section') updateStatsUI('today');
            });
        });
    };

    // --- REWARD LIST RENDER ---
    const renderList = (listId, items, nameField, pointsField = null) => {
        const listEl = document.getElementById(listId);
        if (!listEl) return;
        if (!items.length){
            listEl.innerHTML = `<li>Belum ada reward ditambahkan.</li>`;
            return;
        }
        listEl.innerHTML = items.map(item => `
            <li>
                <span><strong>${item[nameField]}</strong>${pointsField ? ` - ${item[pointsField]} Poin` : ''}</span>
                <button class="btn btn-danger delete-reward-btn" data-id="${item.id}" data-type="${pointsField ? 'points' : 'birthday'}">
                    <span class="btn-text">Hapus</span>
                    <span class="spinner"></span>
                </button>
            </li>
        `).join('');
    };

    const fetchPointRewards = async () => {
        try{
            const snapshot = await getDocs(collection(db,"rewards"));
            allPointRewards = snapshot.docs.map(d => ({ id:d.id, ...d.data() }));
            renderList('point-reward-list', allPointRewards, 'name', 'points');
        }catch(err){ console.error("Gagal memuat reward poin:", err); }
    };

    const fetchBirthdayRewards = async () => {
        try{
            const snapshot = await getDocs(collection(db,"birthdayRewards"));
            allBirthdayRewards = snapshot.docs.map(d => ({ id:d.id, ...d.data() }));
            renderList('birthday-reward-list', allBirthdayRewards, 'name');
        }catch(err){ console.error("Gagal memuat reward ultah:", err); }
    };

    const displayClaimableRewards = (memberPoints) => {
        const container = document.getElementById('claimable-rewards');
        const affordableRewards = allPointRewards.filter(r => (r.points || 0) <= (memberPoints || 0));
        container.innerHTML = affordableRewards.length > 0
            ? `<h4>Reward yang Bisa Diklaim:</h4>` + affordableRewards.map(r => `
                <div class="reward-item">
                    <span><strong>${r.name}</strong> (${r.points} Poin)</span>
                    <button class="btn btn-secondary redeem-btn" data-name="${r.name}" data-points="${r.points}">
                        <span class="btn-text">Redeem</span>
                        <span class="material-symbols-outlined">redeem</span>
                        <span class="spinner"></span>
                    </button>
                </div>
              `).join('')
            : '<h4>Reward yang Bisa Diklaim:</h4><p>Poin belum cukup untuk menukar reward.</p>';
    };

    // --- STATISTIK ---
    const fetchAllStatsData = async () => {
        try{
            const [membersSnap, transactionsSnap, redemptionsSnap] = await Promise.all([
                getDocs(collection(db,"members")),
                getDocs(collection(db,"transactions")),
                getDocs(collection(db,"redemptions"))
            ]);
            allMembers = membersSnap.docs.map(d => ({ id:d.id, ...d.data(), tanggalDaftar: d.data().tanggalDaftar?.toDate?.() || new Date(d.data().tanggalDaftar) }));
            allTransactions = transactionsSnap.docs.map(d => ({ id:d.id, ...d.data(), tanggal: d.data().tanggal?.toDate?.() || new Date(d.data().tanggal) }));
            allRedemptions = redemptionsSnap.docs.map(d => ({ id:d.id, ...d.data(), tanggal: d.data().tanggal?.toDate?.() || new Date(d.data().tanggal) }));
        }catch(err){
            console.error("Gagal mengambil data statistik:", err);
            showStatus("Gagal memuat data statistik.", true);
        }
    };

    const getDateRange = (period) => {
        const now = new Date();
        const start = new Date(now), end = new Date(now);
        if (period === 'today'){
            start.setHours(0,0,0,0); end.setHours(23,59,59,999);
        }else if (period === 'week'){
            const day = (now.getDay() + 6) % 7; // Senin=0
            start.setDate(now.getDate() - day);
            start.setHours(0,0,0,0);
            end.setTime(start.getTime() + 6*24*60*60*1000);
            end.setHours(23,59,59,999);
        }else if (period === 'month'){
            start.setDate(1); start.setHours(0,0,0,0);
            end.setMonth(now.getMonth()+1,0); end.setHours(23,59,59,999);
        }
        return { start, end };
    };

    const updateStatsUI = (period) => {
        let filteredMembers = allMembers;
        let filteredTransactions = allTransactions;
        let filteredRedemptions = allRedemptions;
        if (period !== 'all'){
            const { start, end } = getDateRange(period);
            filteredMembers = allMembers.filter(m => m.tanggalDaftar >= start && m.tanggalDaftar <= end);
            filteredTransactions = allTransactions.filter(t => t.tanggal >= start && t.tanggal <= end);
            filteredRedemptions = allRedemptions.filter(r => r.tanggal >= start && r.tanggal <= end);
        }
        const visitingMemberIds = new Set(filteredTransactions.map(t => t.memberId));

        document.getElementById('stat-total-members').textContent   = allMembers.length;
        document.getElementById('stat-new-members').textContent     = filteredMembers.length;
        document.getElementById('stat-visiting-members').textContent= visitingMemberIds.size;
        document.getElementById('stat-redeemed-rewards').textContent= filteredRedemptions.length;

        updateInfoSourceChart();
    };

    const initializeChart = () => {
        const ctx = document.getElementById('info-source-chart').getContext('2d');
        if (infoSourceChart) infoSourceChart.destroy();
        infoSourceChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: [], datasets: [{ label:'Sumber Info', data: [], backgroundColor: ['#00796B','#F57C00','#4CAF50','#FFC107','#2196F3','#8e44ad','#2ecc71'], hoverOffset:4 }] },
            options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
        });
    };

    const updateInfoSourceChart = () => {
        const sourceCounts = allMembers.reduce((acc, member) => {
            const source = member.sumberInfo || 'Tidak Diketahui';
            acc[source] = (acc[source] || 0) + 1;
            return acc;
        }, {});
        const labels = Object.keys(sourceCounts);
        const data   = Object.values(sourceCounts);
        if (infoSourceChart){
            infoSourceChart.data.labels = labels;
            infoSourceChart.data.datasets[0].data = data;
            infoSourceChart.update();
        }
        updateInfoSourceList(sourceCounts);
    };

    // --- MANAJEMEN MEMBER (SEMUA & REKAP) ---
    const loadAndRenderAllMembers = async () => {
        const listEl = document.getElementById('all-members-list');
        listEl.innerHTML = '<li>Memuat data...</li>';
        try{
            const membersSnap = await getDocs(collection(db,"members"));
            fullMemberList = membersSnap.docs.map(d => ({ id:d.id, ...d.data() }));
            renderMemberList(fullMemberList);
        }catch(err){
            listEl.innerHTML = '<li>Gagal memuat data.</li>';
            console.error("Error loading all members:", err);
        }
    };

    const renderMemberList = (membersToRender) => {
        const listEl = document.getElementById('all-members-list');
        if (!membersToRender.length){
            listEl.innerHTML = '<li>Tidak ada member yang cocok dengan pencarian.</li>';
            return;
        }
        listEl.innerHTML = membersToRender.map(member => {
            const waNumber = formatPhoneNumber(member.nomorHp);
            const birthdayRewardName = getBirthdayReward(member.tanggalLahir);
            const birthdayMessage = birthdayRewardName
                ? `Halo ${member.nama}, selamat ulang tahun! Dolan Sawah punya penawaran spesial untukmu: *${birthdayRewardName}*. Langsung datang ke resto dan tukar reward spesialmu! ðŸŽ‰ðŸ¥³`
                : `Halo ${member.nama}, ada info terbaru nih dari Dolan Sawah!`;
            const whatsappLink = `https://wa.me/${waNumber}?text=${encodeURIComponent(birthdayMessage)}`;

            return `
                <li class="member-list-item" id="member-item-${member.id}">
                    <div class="member-list-item-info">
                        <strong>${member.nama}</strong>
                        <span>${member.nomorHp}</span>
                    </div>
                    <div class="member-list-item-actions">
                        <a href="${whatsappLink}" target="_blank" class="btn btn-info"><span class="btn-text">WhatsApp</span><span class="material-symbols-outlined">chat</span></a>
                        <button class="btn btn-info edit-member-btn" data-id="${member.id}">Edit</button>
                        <button class="btn btn-danger delete-member-btn" data-id="${member.id}" data-name="${member.nama}">Hapus</button>
                    </div>
                </li>
            `;
        }).join('');
    };

    // === PERUBAHAN 6: FUNGSI UNTUK MERENDER LIST REKAP MEMBER BARU ===
    const renderRekapMemberList = (membersToRender) => {
        const listEl = document.getElementById('rekap-member-list');
        if (!membersToRender.length) {
            listEl.innerHTML = '<li>Tidak ada member baru pada periode ini.</li>';
            return;
        }
        listEl.innerHTML = membersToRender.map(member => {
            const waNumber = formatPhoneNumber(member.nomorHp);
            const isVerified = member.isVerified !== false; // Anggap verified jika true atau undefined
            const instagramUser = (member.instagram || '').replace('@','');
            const tiktokUser = (member.tiktok || '').replace('@','');

            return `
                <li class="member-list-item rekap-member-item" id="rekap-item-${member.id}">
                    <div class="member-list-item-info">
                        <div>
                            <strong>${member.nama}</strong>
                            <span>${member.nomorHp}</span>
                        </div>
                        <span class="verification-status ${isVerified ? 'verified' : 'unverified'}">
                            ${isVerified ? 'Terverifikasi' : 'Tidak Terverifikasi'}
                        </span>
                    </div>
                    <div class="member-list-item-actions">
                        <a href="https://wa.me/${waNumber}" target="_blank" class="btn btn-info">
                            <span class="material-symbols-outlined">sms</span>
                        </a>
                        ${instagramUser ? `<a href="https://instagram.com/${instagramUser}" target="_blank" class="btn btn-info" style="background-color:#E1306C;"><span class="btn-text">IG</span></a>` : ''}
                        ${tiktokUser ? `<a href="https://tiktok.com/@${tiktokUser}" target="_blank" class="btn btn-info" style="background-color:#010101;"><span class="btn-text">TikTok</span></a>` : ''}
                        
                        <button class="btn ${isVerified ? 'btn-warning' : 'btn-primary'} toggle-verify-btn" data-id="${member.id}" data-verified="${isVerified}">
                           <span class="btn-text">${isVerified ? 'Tandai Unverified' : 'Tandai Verified'}</span>
                           <span class="material-symbols-outlined">${isVerified ? 'block' : 'check_circle'}</span>
                        </button>
                    </div>
                </li>
            `;
        }).join('');
    };


    // --- INIT ---
    document.addEventListener('DOMContentLoaded', async () => {
        setupNavigation();

        // Cari member
        document.getElementById('search-form').addEventListener('submit', async e => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            showLoading(button, true);
            try{
                const nomorHp = document.getElementById('search-hp').value.trim();
                if (!nomorHp) throw new Error("Nomor HP harus diisi.");
                const docRef  = doc(db,"members", nomorHp);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()){
                    const member = docSnap.data();
                    currentMemberId = member.nomorHp;
                    document.getElementById('info-nama').textContent = member.nama;
                    const currPoint = member.poin || 0;
                    document.getElementById('info-poin').textContent = currPoint;
                    document.getElementById('info-sisa').textContent = formatCurrency(member.sisaPembelanjaan);
                    
                    displayClaimableRewards(currPoint);

                    const birthdayRewardName = getBirthdayReward(member.tanggalLahir);
                    const waBase = `https://wa.me/${formatPhoneNumber(member.nomorHp)}`;
                    if (birthdayRewardName){
                        birthdayNotification.textContent = `ðŸŽ‰ Selamat ulang tahun! Member ini berhak mendapatkan reward spesial: ${birthdayRewardName}.`;
                        birthdayNotification.classList.add('show');
                        document.getElementById('whatsapp-member-btn').href =
                            `${waBase}?text=${encodeURIComponent(`Halo ${member.nama}, selamat ulang tahun! Dolan Sawah punya penawaran spesial untukmu: *${birthdayRewardName}*. Langsung datang ke resto dan tukar reward spesialmu! ðŸŽ‰ðŸ¥³`)}`;
                    }else{
                        birthdayNotification.classList.remove('show');
                        document.getElementById('whatsapp-member-btn').href = waBase;
                    }
                    memberDetailOverlay.classList.add('visible');
                    document.getElementById('transaction-amount').focus();
                }else{
                    showStatus(`Member dengan No. HP ${nomorHp} tidak ditemukan.`, true);
                }
            }catch(err){
                showStatus(err.message || "Terjadi kesalahan.", true);
            }finally{
                showLoading(button, false);
            }
        });

        // Daftar member
        document.getElementById('register-form').addEventListener('submit', async e => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            showLoading(button, true);
            const form = e.target;
            const nomorHp = form.querySelector('#nomor-hp').value.trim();
            try{
                const docRef  = doc(db,"members", nomorHp);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) throw new Error("Nomor HP ini sudah terdaftar sebagai member.");
                
                // === PERUBAHAN 7: Tambah data medsos dan verifikasi ke database ===
                await setDoc(docRef, {
                    nama: form.querySelector('#nama').value,
                    alamat: form.querySelector('#alamat').value,
                    nomorHp,
                    tanggalLahir: form.querySelector('#tanggal-lahir').value,
                    sumberInfo: form.querySelector('#sumber-info').value,
                    instagram: form.querySelector('#instagram').value.trim(),
                    tiktok: form.querySelector('#tiktok').value.trim(),
                    isVerified: true, // Default status adalah terverifikasi
                    poin: 0,
                    sisaPembelanjaan: 0,
                    tanggalDaftar: new Date()
                });
                // === AKHIR PERUBAHAN 7 ===

                showStatus("Member baru berhasil didaftarkan!");
                form.reset();
                document.getElementById('nav-search').click();
                document.getElementById('search-hp').value = nomorHp;
                document.querySelector('#search-form button[type="submit"]').click();
                
                await fetchAllStatsData();
                updateStatsUI('today');
            }catch(err){
                showStatus(err.message || "Gagal mendaftar.", true);
            }finally{
                showLoading(button, false);
            }
        });

        document.getElementById('add-transaction-form').addEventListener('submit', async e => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            const amountInput = document.getElementById('transaction-amount');
            const amount = parseInt(amountInput.value, 10);

            if (!amount || !currentMemberId || amount <= 0) {
                showStatus("Masukkan nominal transaksi yang valid.", true);
                return;
            }
            
            showLoading(button, true);
            const memberDocRef = doc(db, "members", currentMemberId);

            try {
                let pointsGained = 0;
                await runTransaction(db, async (transaction) => {
                    const memberDoc = await transaction.get(memberDocRef);
                    if (!memberDoc.exists()) {
                        throw new Error("Member tidak ditemukan.");
                    }

                    const data = memberDoc.data();
                    const oldRemainder = data.sisaPembelanjaan || 0;
                    const totalForPoints = amount + oldRemainder;
                    
                    pointsGained = Math.floor(totalForPoints / POIN_THRESHOLD);
                    const newRemainder = totalForPoints % POIN_THRESHOLD;

                    transaction.update(memberDocRef, {
                        poin: increment(pointsGained),
                        sisaPembelanjaan: newRemainder
                    });
                });
                
                await addDoc(collection(db, "transactions"), { 
                    memberId: currentMemberId, 
                    nominal: amount, 
                    poinDidapat: pointsGained,
                    tanggal: new Date() 
                });

                showStatus(`Transaksi berhasil! Member mendapat ${pointsGained} poin.`);
                e.target.reset();
                memberDetailOverlay.classList.remove('visible');
                await fetchAllStatsData();
                updateStatsUI('today');

            } catch (err) {
                showStatus(err.message || "Gagal menyimpan transaksi.", true);
                console.error("Transaction failed: ", err);
            } finally {
                showLoading(button, false);
            }
        });

        document.getElementById('member-detail-overlay').addEventListener('click', async e => {
            const button = e.target.closest('.redeem-btn');
            if (!button) return;
            const { name, points } = button.dataset;
            const pointsCost = parseInt(points, 10);
            if (!confirm(`Tukar ${pointsCost} poin dengan "${name}"? Poin member akan dikurangi.`)) return;
            showLoading(button, true);
            try{
                const memberDocRef = doc(db,"members", currentMemberId);
                await updateDoc(memberDocRef, { poin: increment(-pointsCost) });
                await addDoc(collection(db,"redemptions"), { memberId: currentMemberId, rewardName: name, pointsSpent: pointsCost, tanggal:new Date() });

                const poinDisplay = document.getElementById('info-poin');
                const newPoints = Math.max(0, (parseInt(poinDisplay.textContent,10) || 0) - pointsCost);
                poinDisplay.textContent = newPoints;
                displayClaimableRewards(newPoints);
                showStatus(`Poin berhasil ditukar dengan ${name}!`);
                await fetchAllStatsData();
                updateStatsUI('today');
            }catch(err){
                showStatus("Gagal menukar poin.", true);
            }finally{
                showLoading(button, false);
            }
        });

        backToSearchBtn.addEventListener('click', () => {
            memberDetailOverlay.classList.remove('visible');
            document.getElementById('search-form').reset();
            document.getElementById('search-hp').focus();
            birthdayNotification.classList.remove('show');
        });

        document.getElementById('add-point-reward-form').addEventListener('submit', async e => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            showLoading(button, true);
            try{
                const name = document.getElementById('reward-name').value.trim();
                const points = parseInt(document.getElementById('reward-points').value, 10);
                if (!name || !points) throw new Error("Nama dan Poin Reward harus diisi.");
                await addDoc(collection(db,"rewards"), { name, points });
                showStatus("Reward poin berhasil ditambahkan!");
                e.target.reset();
                await fetchPointRewards();
            }catch(err){
                showStatus(err.message || "Gagal menambah reward.", true);
            }finally{
                showLoading(button, false);
            }
        });

        document.getElementById('add-birthday-reward-form').addEventListener('submit', async e => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            showLoading(button, true);
            try{
                const name = document.getElementById('birthday-reward-name').value.trim();
                if (!name) throw new Error("Nama Reward harus diisi.");
                await addDoc(collection(db,"birthdayRewards"), { name });
                showStatus("Reward ultah berhasil ditambahkan!");
                e.target.reset();
                await fetchBirthdayRewards();
            }catch(err){
                showStatus(err.message || "Gagal menambah reward ultah.", true);
            }finally{
                showLoading(button, false);
            }
        });

        document.getElementById('rewards-section').addEventListener('click', async e => {
            const button = e.target.closest('.delete-reward-btn');
            if (!button) return;
            if (!confirm("Yakin ingin menghapus reward ini?")) return;
            showLoading(button, true);
            try{
                const { id, type } = button.dataset;
                const collectionName = (type === 'points') ? 'rewards' : 'birthdayRewards';
                await deleteDoc(doc(db, collectionName, id));
                showStatus("Reward berhasil dihapus.");
                (type === 'points') ? await fetchPointRewards() : await fetchBirthdayRewards();
            }catch(err){
                showStatus("Gagal menghapus reward.", true);
            }finally{
                showLoading(button, false);
            }
        });

        document.getElementById('btn-show-point-rewards').addEventListener('click', () => {
            document.getElementById('reward-options').classList.add('hidden');
            document.getElementById('point-rewards-container').classList.remove('hidden');
        });
        document.getElementById('btn-show-birthday-rewards').addEventListener('click', () => {
            document.getElementById('reward-options').classList.add('hidden');
            document.getElementById('birthday-rewards-container').classList.remove('hidden');
        });
        document.querySelectorAll('.back-to-reward-options').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById('reward-options').classList.remove('hidden');
                document.getElementById('point-rewards-container').classList.add('hidden');
                document.getElementById('birthday-rewards-container').classList.add('hidden');
            });
        });

        document.querySelector('.stats-filter').addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') return;
            document.querySelectorAll('.stats-filter button').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            updateStatsUI(e.target.dataset.period);
        });

        document.getElementById('show-all-members-btn').addEventListener('click', () => {
            passwordPromptOverlay.classList.add('visible');
            document.getElementById('admin-password').focus();
        });
        document.getElementById('cancel-password-btn').addEventListener('click', () => passwordPromptOverlay.classList.remove('visible'));

        document.getElementById('password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('admin-password').value;
            if (password === '654321'){
                passwordPromptOverlay.classList.remove('visible');
                e.target.reset();
                await loadAndRenderAllMembers();
                allMembersOverlay.classList.add('visible');
            }else{
                showStatus("Password salah!", true, 'status-message');
                e.target.reset();
            }
        });

        document.getElementById('search-all-members-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = fullMemberList.filter(m => (m.nomorHp || '').toLowerCase().includes(term));
            renderMemberList(filtered);
        });
        document.getElementById('close-all-members-btn').addEventListener('click', () => allMembersOverlay.classList.remove('visible'));

        document.getElementById('all-members-list').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            const { id: memberId, name: memberName } = button.dataset;
            
            if (button.classList.contains('delete-member-btn')){
                if (!confirm(`Yakin ingin menghapus member "${memberName}" (${memberId})? Data tidak bisa dikembalikan.`)) return;
                try{
                    await deleteDoc(doc(db,"members", memberId));
                    showStatus("Member berhasil dihapus.");
                    document.getElementById(`member-item-${memberId}`)?.remove();
                    fullMemberList = fullMemberList.filter(m => m.id !== memberId);
                    await fetchAllStatsData();
                    updateStatsUI('today');
                }catch(err){
                    showStatus("Gagal menghapus member.", true);
                    console.error("Delete error:", err);
                }
            }else if (button.classList.contains('edit-member-btn')){
                const memberData = fullMemberList.find(m => m.id === memberId);
                if (memberData){
                    const form = document.getElementById('edit-member-form');
                    form.querySelector('#edit-member-id').value = memberData.id;
                    form.querySelector('#edit-nama').value = memberData.nama || '';
                    form.querySelector('#edit-alamat').value = memberData.alamat || '';
                    form.querySelector('#edit-nomor-hp').value = memberData.nomorHp || '';
                    form.querySelector('#edit-tanggal-lahir').value = memberData.tanggalLahir || '';
                    form.querySelector('#edit-sumber-info').value = memberData.sumberInfo || '';
                    // === PERUBAHAN 8: Isi data medsos di form edit ===
                    form.querySelector('#edit-instagram').value = memberData.instagram || '';
                    form.querySelector('#edit-tiktok').value = memberData.tiktok || '';
                    form.querySelector('#edit-poin').value = memberData.poin || 0;
                    form.querySelector('#edit-sisa-pembelanjaan').value = memberData.sisaPembelanjaan || 0;
                    editMemberOverlay.classList.add('visible');
                }
            }
        });

        document.getElementById('cancel-edit-btn').addEventListener('click', () => editMemberOverlay.classList.remove('visible'));
        document.getElementById('edit-member-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            showLoading(button, true);
            const memberId = document.getElementById('edit-member-id').value;
            // === PERUBAHAN 9: Sertakan data medsos saat update ===
            const updatedData = {
                nama: document.getElementById('edit-nama').value,
                alamat: document.getElementById('edit-alamat').value,
                tanggalLahir: document.getElementById('edit-tanggal-lahir').value,
                sumberInfo: document.getElementById('edit-sumber-info').value,
                instagram: document.getElementById('edit-instagram').value.trim(),
                tiktok: document.getElementById('edit-tiktok').value.trim(),
                poin: parseInt(document.getElementById('edit-poin').value,10) || 0,
                sisaPembelanjaan: parseInt(document.getElementById('edit-sisa-pembelanjaan').value,10) || 0
            };
             // === AKHIR PERUBAHAN 9 ===
            try{
                const memberDocRef = doc(db,"members", memberId);
                await updateDoc(memberDocRef, updatedData);
                showStatus("Data member berhasil diupdate.");
                editMemberOverlay.classList.remove('visible');
                await loadAndRenderAllMembers();
                await fetchAllStatsData();
                updateStatsUI('today');
            }catch(err){
                showStatus("Gagal mengupdate data.", true);
                console.error("Update error:", err);
            }finally{
                showLoading(button, false);
            }
        });

        // === PERUBAHAN 10: SEMUA LOGIKA UNTUK FITUR REKAP MEMBER BARU ===
        const showRekapData = (period) => {
            const { start, end } = getDateRange(period);
            const data = (fullMemberList.length > 0 ? fullMemberList : allMembers).map(m => ({
                ...m,
                tanggalDaftar: m.tanggalDaftar?.toDate?.() || new Date(m.tanggalDaftar)
            }));
            const filtered = data.filter(m => m.tanggalDaftar >= start && m.tanggalDaftar <= end);
            renderRekapMemberList(filtered);
        };

        document.getElementById('rekap-member-baru-btn').addEventListener('click', async () => {
            // Muat data jika belum ada
            if (fullMemberList.length === 0) {
                 await loadAndRenderAllMembers();
            }
            // Tampilkan data hari ini secara default
            showRekapData('today');
            rekapMemberOverlay.classList.add('visible');
        });

        document.getElementById('close-rekap-btn').addEventListener('click', () => rekapMemberOverlay.classList.remove('visible'));

        document.getElementById('rekap-filter').addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') return;
            document.querySelectorAll('#rekap-filter button').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            showRekapData(e.target.dataset.period);
        });

        document.getElementById('rekap-member-list').addEventListener('click', async (e) => {
            const button = e.target.closest('.toggle-verify-btn');
            if (!button) return;

            const memberId = button.dataset.id;
            const currentStatus = button.dataset.verified === 'true';
            const newStatus = !currentStatus;

            showLoading(button, true);
            try {
                const memberDocRef = doc(db, "members", memberId);
                await updateDoc(memberDocRef, { isVerified: newStatus });

                // Update data lokal agar UI sinkron tanpa reload
                const memberIndex = fullMemberList.findIndex(m => m.id === memberId);
                if (memberIndex > -1) {
                    fullMemberList[memberIndex].isVerified = newStatus;
                }
                 const memberIndexAll = allMembers.findIndex(m => m.id === memberId);
                if (memberIndexAll > -1) {
                    allMembers[memberIndexAll].isVerified = newStatus;
                }

                // Update UI secara langsung
                const listItem = document.getElementById(`rekap-item-${memberId}`);
                const statusBadge = listItem.querySelector('.verification-status');
                statusBadge.textContent = newStatus ? 'Terverifikasi' : 'Tidak Terverifikasi';
                statusBadge.className = `verification-status ${newStatus ? 'verified' : 'unverified'}`;
                
                button.dataset.verified = newStatus;
                button.querySelector('.btn-text').textContent = newStatus ? 'Tandai Unverified' : 'Tandai Verified';
                button.querySelector('.material-symbols-outlined').textContent = newStatus ? 'block' : 'check_circle';
                button.className = `btn ${newStatus ? 'btn-warning' : 'btn-primary'} toggle-verify-btn`;

                showStatus("Status verifikasi berhasil diubah.");

            } catch (err) {
                showStatus("Gagal mengubah status verifikasi.", true);
                console.error("Verification toggle error:", err);
            } finally {
                showLoading(button, false);
            }
        });
        // === AKHIR PERUBAHAN 10 ===

        // Init data + chart
        await fetchPointRewards();
        await fetchBirthdayRewards();
        await fetchAllStatsData();
        initializeChart();
        updateStatsUI('today');

        window.addEventListener('resize', () => { if (infoSourceChart) infoSourceChart.resize(); });
    });
</script>
</body>
</html>
